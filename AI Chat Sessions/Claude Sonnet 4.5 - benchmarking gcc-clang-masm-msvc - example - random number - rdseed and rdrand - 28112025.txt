New chat
Chats
Projects
Artifacts
Code
Recents
Hide
Debugging artifact extraction script issues
PowerShell script string terminator error
Creating EFI boot entries in Arch Linux chroot
Archlinux next button issue
PCRE2 vs PCRE regex differences
Script extracting unintended content across websites
Package installation performance on external drive
GIMP build script symbolic link error
File sharing between iPad and Windows laptop
Installing latest Brave nightly on Arch Linux
DNF5 repository configuration syntax
Comparing portable MSVC build tools
Brave browser and gvim not launching from start menu
Primesieve C extension build failure on Windows
Gemini 3 vs Claude Sonnet 4.5 performance comparison
AVX512 support in ripgrep binary packages
Spyder startup error from Windows start menu
GCC vs Visual Studio compiler comparison
Copying chat sessions with artifacts to Word
Speeding up slow Fedora boot on external HDD
Visual Studio Code new feature overview
Polars Expr apply method error
Understanding prompt limits and session cooldown
Waybar battery alert threshold off by one percent
GIMP build script with dependency installation
Sway screenshot to clipboard keybinding
RTL8852BE 5 GHz WiFi driver installation on Linux
Linux WiFi network configuration persistence issue
Debugging broken script issue
Arch Linux systemd-boot initrd error
RTL8852be 5G wifi driver Linux compatibility
Reinstalling wifi drivers on Fedora
All chats
D
Dhawal
Free plan
PowerShell script string terminator error
Share
testing_benchmarking_rdrand_performance.ps1

203 lines

PS1

D

See attached script. Some error (Powershell script with embedded c code and compilation inside)
PS D:\dev\msvc> .\testing_benchmarking_rdrand_performance.ps1
ParserError: D:\dev\msvc\testing_benchmarking_rdrand_performance.ps1:200
Line |
 200 |      Write-Host "‚úì MSVC compilation successful" -ForegroundColor Green
     |                                               ~~~~~~~~~~~~~~~~~~~~~~~~
     | The string is missing the terminator: ".

The issue is with the checkmark character (‚úì) in the PowerShell script. PowerShell is having trouble parsing it due to encoding issues. Here's the corrected script:

Fixed RDRAND/RDSEED Benchmark Script
Code¬†
# =====================================================
# Create Fixed Benchmark Source Code
# =====================================================

@"
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

// Include in

The problem was in your original script - there was duplicate code at the end that was malformed. The main issues were:

Duplicate content: The script had the C code being written to the file twice with Out-File
Unicode characters: The checkmark (‚úì) and X (‚úó) characters were causing encoding issues
Incomplete string literals: The second attempt to write the C code wasn't properly closed

I've fixed it by:

Removing the duplicate code
Replacing ‚úì with [OK] and ‚úó with [ERROR] (ASCII-safe)
Properly structuring the PowerShell commands after the C code generation

Save this corrected version and run it. It should now compile and execute the benchmark properly!

D

Stuck here:

PS D:\dev\msvc> .\testing_benchmarking_rdrand_performance.ps1
=====================================================
  Fixed RDRAND/RDSEED Benchmark
=====================================================
=== Compiling with MSVC ===
benchmark_comprehensive_fixed.c
[OK] MSVC compilation successful
Running MSVC benchmark...
====================================================
     RDRAND/RDSEED Performance Benchmark
====================================================
Compiler: MSVC 1950
Iterations (RDRAND): 10000000
Iterations (RDSEED): 1000000
====================================================
RDRAND64 Performance
====================================================

Show more

The benchmark is running but appears to be stuck during the RDRAND64 performance test. This is likely because the rdrand64_intrinsic function is taking a very long time or hanging. The issue might be:

RDRAND instruction not supported on your CPU
Infinite retry loop if RDRAND keeps failing
Very slow performance making 10 million iterations take too long

Let me create an improved version with better diagnostics and CPU feature detection:

Fixed RDRAND/RDSEED Benchmark Script
Code‚ÄÇ‚àô‚ÄÇVersion 2¬†
# =====================================================
# Create Enhanced Benchmark with CPU Detection
# =====================================================

@"
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#if

The improved version includes:

CPU feature detection - Checks if your CPU actually supports RDRAND/RDSEED before running
Progress indicators - Shows dots during the benchmark so you know it's working
Quick test first - Generates 10 random values to verify RDRAND works
Lower iteration counts - Starts with 1 million instead of 10 million for RDRAND
Better error handling - Increased retry limits and checks for failures
Warmup feedback - Shows progress during warmup phase

Run this version. If it still hangs:

It will show progress dots, so you'll know if it's actually running or truly stuck
You can press Ctrl+C to stop it
The CPU detection will tell us if RDRAND is even supported on your processor

What CPU are you running this on? RDRAND was introduced with Intel Ivy Bridge (2012) and AMD CPUs starting around 2015.

D

Why this part not terminated properly:

"@ | Out-File -Encoding ASCII benchmark_comprehensive_fixed.c  Write-Host "=====================================================" -ForegroundColor Cyan Write-Host "  Enhanced RDRAND/RDSEED Benchmark" -ForegroundColor Cyan Write-Host "=====================================================" -ForegroundColor Cyan  # Test with MSVC Write-Host n=== Compiling with MSVC ===" -ForegroundColor Yellow cl /O2 benchmark_comprehensive_fixed.c /Fe:benchmark_msvc_fixed.exe /nologo 2>$null if ($LASTEXITCODE -eq 0) {     Write-Host "[OK] MSVC compilation successful" -ForegroundColor Green     Write-Host "nRunning MSVC benchmark..." -ForegroundColor Cyan     Write-Host "(Press Ctrl+C if it hangs)" -ForegroundColor Yellow     .\benchmark_msvc_fixed.exe } else {     Write-Host "[ERROR] MSVC compilation failed" -ForegroundColor Red }

Show more

Good catch! The issue is that the line after the here-string terminator ("@) needs to be on its own line with no other code on it. In PowerShell, the closing "@ must be at the start of a line by itself.

Here's the corrected version:

Fixed RDRAND/RDSEED Benchmark Script
Code‚ÄÇ‚àô‚ÄÇVersion 3¬†
"@ | Out-File -Encoding ASCII benchmark_comprehensive_fixed.c

Write-Host "=====================================================" -ForegroundColor Cyan

Actually, looking at the artifact, it's already correct! The formatting just looks compressed when you copied it. In the actual script file, each command should be on its own line:

powershell
"@ | Out-File -Encoding ASCII benchmark_comprehensive_fixed.c

Write-Host "=====================================================" -ForegroundColor Cyan
Write-Host "  Enhanced RDRAND/RDSEED Benchmark" -ForegroundColor Cyan

The key rule: The closing "@ must be at the beginning of a line with nothing before it, and you can have a pipe | after it on the same line.

If you're still getting errors, save the artifact I created as a .ps1 file and run it. The artifact has proper line breaks. The issue you might be seeing is just how the text appears when displayed inline - the actual file structure is correct.

D

But I need benchmarking to compare fastest to slowest from amongst:

gcc /gnu
clang / gnu
clang (windows0
msvc (windows)
masm (pure assembly code)

to test HRNG generation (64 bit) using both rdrand and rdseed and summary table at the end. Are all these covered in this script?

No, the current script only tests MSVC. Let me create a comprehensive script that tests all those compilers and creates a summary comparison table:

Fixed RDRAND/RDSEED Benchmark Script
Code‚ÄÇ‚àô‚ÄÇVersion 4¬†
# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

# Create C source code with all implementations
@"
#include <stdio.h>
#include <s

This comprehensive script now:

Tests all 5 compiler/method combinations:
MSVC (intrinsic)
Clang Windows (intrinsic + inline ASM)
GCC (intrinsic + inline ASM)
MASM (pure assembly)
Benchmarks both RDRAND and RDSEED for each compiler
Creates a summary table showing:
Performance in ns/call (lower is better)
Throughput in millions/sec
Results sorted from fastest to slowest
Highlights the overall fastest implementation
Handles missing compilers gracefully - if GCC or Clang aren't installed, it skips them and continues

The script will generate separate executables for each compiler and display a comprehensive comparison table at the end showing which compiler/method combination is fastest for RDRAND and RDSEED.

D

what about clang /gnu (msys) which is a different toolchain than gcc.

You're absolutely right! Clang in MSYS2 uses the GNU toolchain (targeting GNU/Linux-like environment) which is different from Clang on Windows (targeting MSVC ABI). Let me update the script to test both:

Fixed RDRAND/RDSEED Benchmark Script
Code‚ÄÇ‚àô‚ÄÇVersion 5¬†
# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: 
Fixed RDRAND/RDSEED Benchmark Script
Code‚ÄÇ‚àô‚ÄÇVersion 8¬†
# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow

Perfect! Now the script tests 6 distinct compiler/toolchain combinations:

MSVC - Microsoft Visual C++ (intrinsic only, no inline ASM in x64)
Clang (Windows/MSVC ABI) - Clang targeting Windows native (intrinsic + inline ASM)
Clang (MSYS2/GNU) - Clang using GNU toolchain from MSYS2 (intrinsic + inline ASM)
GCC - GNU Compiler Collection from MinGW/MSYS2 (intrinsic + inline ASM)
MASM - Microsoft Macro Assembler (pure assembly)

The key differences:

Clang (Win) uses MSVC ABI, Windows headers, and targets native Windows
Clang (GNU) uses GNU toolchain, may have different optimizations and runtime behavior
Both Clang variants support inline assembly unlike MSVC

The script automatically detects if MSYS2 Clang is installed in standard locations (C:\msys64\mingw64, clang64, or ucrt64) and tests it separately. At the end, you'll get a comprehensive comparison table showing which toolchain produces the fastest RDRAND/RDSEED implementation!

PS D:\dev\msvc> .\testing_benchmarking_rdrand_performance_comprehensive_3.ps1 #include <stdio.h> #include <stdint.h> #include <immintrin.h> #include <windows.h> #ifdef _MSC_VER #include <intrin.h> #endif // CPU feature detection int check_rdrand_support() { int cpuInfo[4]; __c

PASTED

D

Something wrong with the code:

I see the issues! The script is outputting the C code to the console instead of writing it to files, and there are errors in the file output. Let me fix it:

Fixed RDRAND/RDSEED Benchmark Script
Code‚ÄÇ‚àô‚ÄÇVersion 9¬†
# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundC

The key fixes:

Used here-strings properly - Stored the code in variables ($cCode, $asmCode, $masmWrapper) first, then piped to Out-File
Fixed MSVC compilation - Added /link /OUT:benchmark_msvc.exe to properly link the executable
Fixed MASM linking - Added /link /OUT:benchmark_masm.exe for the MASM version
Redirected error output - Used 2>&1 to suppress compiler warnings/errors in the console
Better output capture - Used Out-String to properly capture program output for parsing

Now the script should:

Create the source files correctly
Compile successfully with MSVC (which you have)
Show proper compilation status for each compiler
Generate the comparison table at the end

Run this version and it should work!

D

Stuck here:

PS D:\dev\msvc> .\testing_benchmarking_rdrand_performance_comprehensive_3.ps1
=====================================================
  RDRAND/RDSEED Multi-Compiler Benchmark
  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM
=====================================================
[1/6] Testing MSVC...
  Compilation: OK

The benchmark is running but stuck during execution. This is the same issue as before - the RDRAND instruction is taking a very long time. Let me add a timeout mechanism and better progress tracking:

Fixed RDRAND/RDSEED Benchmark Script
Code‚ÄÇ‚àô‚ÄÇVersion 10¬†
# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "
Fixed RDRAND/RDSEED Benchmark Script
Code‚ÄÇ‚àô‚ÄÇVersion 11¬†
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
 

Actually, let me create a better solution - reduce the iteration count dramatically for the first test run to see if RDRAND works at all:

Fixed RDRAND/RDSEED Benchmark Script
Code‚ÄÇ‚àô‚ÄÇVersion 12¬†
int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
Fixed RDRAND/RDSEED Benchmark Script
Code‚ÄÇ‚àô‚ÄÇVersion 13¬†
int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K

Now let me also update the MASM wrapper with the same reduced iterations:

Fixed RDRAND/RDSEED Benchmark Script
Code‚ÄÇ‚àô‚ÄÇVersion 14¬†
int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: MASM + MSVC\n");

Perfect! I've made two key changes:

Reduced iteration counts from 5 million to 100K for RDRAND and 500K to 50K for RDSEED - this should complete in a few seconds instead of hanging
Added timeout protection with progress messages so you know it's working

The reduced iterations will still give accurate ns/call measurements but will complete much faster. If it still hangs even with 100K iterations, that indicates a serious problem with RDRAND on your CPU.

Try running the script again. It should now:

Complete the MSVC test in under 5 seconds
Show "Running benchmark (this may take 10-30 seconds)..." message
Timeout after 60 seconds if something goes wrong
Display results immediately when done

What CPU model are you testing on? If RDRAND is extremely slow, we might need to investigate why.

setup-all-compilers.ps1

96 lines

PS1

D

No I did not change and went with version 9 only (previous one). I have setup environment like this. Attached But still get this error:

PS D:\dev\msvc> .\testing_benchmarking_rdrand_performance_comprehensive_3.ps1
=====================================================
  RDRAND/RDSEED Multi-Compiler Benchmark
  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM
=====================================================
[1/6] Testing MSVC...
  Compilation: OK
  Running benchmark (this may take 10-30 seconds)...
Compiler: MSVC 1950
RDRAND Benchmarks (100000 iterations):
  Intrinsic: 16388.90 ns/call (0.06 M/sec)
RDRAND_INTRINSIC:16388.90
RDSEED Benchmarks (50000 iterations):
  Intrinsic: 81779.89 ns/call (0.01 M/sec)
RDSEED_INTRINSIC:81779.89
RDSEED_VS_RDRAND:4.99x
[2/6] Testing Clang (Windows/MSVC ABI)...
  Compilation: FAILED (Clang not found or not in PATH)
[3/6] Testing Clang (MSYS2/GNU toolchain)...
  Compilation: SKIPPED (MSYS2 Clang not found in standard locations)
  Checked: C:\msys64\mingw64\bin, C:\msys64\clang64\bin, C:\msys64\ucrt64\bin
[4/6] Testing GCC (GNU toolchain)...
  Compilation: FAILED (GCC not found or not in PATH)
[5/6] Testing MASM (Pure Assembly)...
  Compilation: OK
Compiler: MASM + MSVC
RDRAND Benchmarks (100000 iterations):
  Pure ASM: 16101.25 ns/call (0.06 M/sec)
RDRAND_INTRINSIC:16101.25
RDSEED Benchmarks (50000 iterations):
  Pure ASM: 81929.87 ns/call (0.01 M/sec)
RDSEED_INTRINSIC:81929.87
RDSEED_VS_RDRAND:5.09x
=====================================================
  BENCHMARK RESULTS SUMMARY
=====================================================
RDRAND Performance (lower is better):
Compiler Method    RDRAND (ns) Speed (M/s)
-------- ------    ----------- -----------
MASM     Pure ASM    16,101.25        0.06
MSVC     Intrinsic   16,388.90        0.06
RDSEED Performance (lower is better):
Compiler Method    RDSEED (ns) Speed (M/s)
-------- ------    ----------- -----------
MSVC     Intrinsic   81,779.89        0.01
MASM     Pure ASM    81,929.87        0.01
=====================================================
Fastest RDRAND: MASM (Pure ASM) - 16,101.25 ns/call
Fastest RDSEED: MSVC (Intrinsic) - 81,779.89 ns/call
=====================================================
Done! Executables and source files saved in current directory.

2/6 - clang and 4/6 gcc (gnu) not in path But I have setup Paths correctly. Clang (windows) is at D:\Programs\clang (bin, share, include and other folders in that - windows version) and gcc is at: D:\Programs\msys64\ucrt64 (where there are bin and other folders)

Show more

The issue is that your script is running in a fresh PowerShell session that doesn't have the environment variables from your setup script. You need to either:

Run the setup script first in the same PowerShell session, OR
Modify the benchmark script to use full paths

Let me update the benchmark script to automatically detect and use the paths from your setup:

Fixed RDRAND/RDSEED Benchmark Script
Code‚ÄÇ‚àô‚ÄÇVersion 15¬†
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor 
Fixed RDRAND/RDSEED Benchmark Script
Code‚ÄÇ‚àô‚ÄÇVersion 18¬†
# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
if ($gccPath) {
    $null = & $gccPath -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Hos

Perfect! Now the script will:

Auto-detect all compilers at the hardcoded paths you specified
Show which compilers were found before starting tests
Use full paths instead of relying on PATH environment variable
Add timeout protection to all benchmarks

The key changes:

Added compiler detection at the beginning that checks for:
D:\Programs\clang\bin\clang.exe (Clang Windows)
D:\Programs\msys64\ucrt64\bin\gcc.exe (GCC)
D:\Programs\msys64\ucrt64\bin\clang.exe (Clang GNU)
Each test now uses the full path instead of assuming it's in PATH
All benchmarks now have timeout protection

Run this updated version and it should find and test all your compilers! You'll see a detection summary at the start showing which compilers were found.

D

I think you are making a mistake.

Detecting compilers...
  MSVC (cl): Found in PATH
  Clang (Win): Found at D:\Programs\clang\bin\clang.exe
  GCC (MSYS2): Found at D:\Programs\msys64\ucrt64\bin\gcc.exe
  Clang (GNU): Found at D:\Programs\msys64\ucrt64\bin\clang.exe

This is okay but what about lib and include - Does the script take care of them? Although those paths are set and I ran the setup script before running this script.¬†

Your changed script also failed:

[2/6] Testing Clang (Windows/MSVC ABI)...
  Compilation: FAILED (Clang not found or not in PATH)
[3/6] Testing Clang (MSYS2/GNU toolchain)...
  Compilation: FAILED
[4/6] Testing GCC (GNU toolchain)...
  Compilation: FAILED

Show more

You're absolutely right! The script detects the compilers but isn't using the full paths, and more importantly, it's not inheriting the environment variables (INCLUDE, LIB) that you set with your setup script.

The issue is that Start-Job creates a completely new PowerShell session that doesn't inherit your environment variables. Let me fix this:

Fixed RDRAND/RDSEED Benchmark Script
Code‚ÄÇ‚àô‚ÄÇVersion 19¬†
# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
if ($clangWinPath) {
    # Clang on Windows needs INCLUDE and LIB paths for headers and libraries
    $env:INCLUDE = "D:\dev\msvc\VC\To
Fixed RDRAND/RDSEED Benchmark Script
Code‚ÄÇ‚àô‚ÄÇVersion 24¬†
            
            $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdrand_asm_spe

Perfect! The key fixes:

Removed Start-Job - This was creating new sessions without your environment variables
Added environment setup directly in the script:
For Clang (Windows): Sets INCLUDE and LIB to point to MSVC headers and libraries
For GCC/Clang (GNU): Adds MSYS2 bin directory to PATH for runtime DLLs
Runs executables directly in the current session so they inherit all environment variables

Now the script:

Inherits all environment variables from your setup script
Sets additional required paths before each compilation
Should compile and run successfully with all compilers

To use it:

powershell
# Run your setup script first
. .\setup-all-compilers.ps1

# Then run the benchmark
.\testing_benchmarking_rdrand_performance_comprehensive_3.ps1

This should now successfully compile and run with Clang (Windows), Clang (GNU), and GCC!

D

Still same errors:

[2/6] Testing Clang (Windows/MSVC ABI)...
  Compilation: FAILED (Clang not found or not in PATH)
[3/6] Testing Clang (MSYS2/GNU toolchain)...
  Compilation: FAILED
[4/6] Testing GCC (GNU toolchain)...
  Compilation: FAILED

I think your script is not detecting other than msvc - clang (both gnu and windows) and gcc.

You're right! I see the issue now. Look at the detection output - it says the compilers are found, but then the compilation still fails. The problem is in the if statements - they're checking if the path exists, but then the actual compilation code isn't being executed. Let me check the logic flow:

Fixed RDRAND/RDSEED Benchmark Script
Code‚ÄÇ‚àô‚ÄÇVersion 25¬†
# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
if ($clangWinPath -and (Test-Path $clangWinPath)) {
    # Clang on Windows needs INCLUDE and LIB paths for headers and libraries
    $e
Fixed RDRAND/RDSEED Benchmark Script
Code‚ÄÇ‚àô‚ÄÇVersion 27¬†
# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
if ($gccPath -and (Test-Path $gccPath)) {
    # Set up MSYS2 library paths
    $env:PATH = "D:\Programs\msys64\ucrt64\bin;$env:PATH"
    
    Write-H

Perfect! Now I've added:

Better path validation - Checks both that the variable exists AND that the file actually exists
Compilation output capture - Stores error messages instead of discarding them with $null
Error display - Shows actual compilation errors so we can see what's going wrong
Progress messages - Shows which compiler path is being used

Now when you run it, if compilation fails, you'll see the actual error messages from the compiler, which will tell us exactly what's wrong (missing headers, wrong library paths, etc.).

Run this version and share the error output - that will tell us exactly what's failing!

D

??

[2/6] Testing Clang (Windows/MSVC ABI)...
  Compilation: FAILED (Clang not found or not in PATH)
[3/6] Testing Clang (MSYS2/GNU toolchain)...
  Compiling with D:\Programs\msys64\ucrt64\bin\clang.exe...
  Compilation: FAILED
  Error output:
benchmark_multi.c:13:5: error: call to undeclared function '__cpuid'; ISO C99 and later do not support implicit function declarations [-Wimplicit-function-declaration]    13 |     __cpuid(cpuInfo, 1);       |     ^ benchmark_multi.c:19:5: error: call to undeclared function '__cpuidex'; ISO C99 and later do not support implicit function declarations [-Wimplicit-function-declaration]    19 |     __cpuidex(cpuInfo, 7, 0);       |     ^ 2 errors generated.
[4/6] Testing GCC (GNU toolchain)...
  Compiling with D:\Programs\msys64\ucrt64\bin\gcc.exe...
  Compilation: FAILED
  Error output:
benchmark_multi.c: In function 'check_rdrand_support': benchmark_multi.c:13:5: error: implicit declaration of function '__cpuid'; did you mean '_clui'? [-Wimplicit-function-declaration]    13 |     __cpuid(cpuInfo, 1);       |     ^~~~~       |     _clui benchmark_multi.c: In function 'check_rdseed_support': benchmark_multi.c:19:5: error: implicit declaration of function '__cpuidex' [-Wimplicit-function-declaration]    19 |     __cpuidex(cpuInfo, 7, 0);       |     ^~~~~~~

Show more

Ah! Now I see the problem! The __cpuid and __cpuidex functions are MSVC-specific intrinsics. For GCC and Clang on GNU systems, we need to use different code. Let me fix the C source to be compatible with all compilers:

Fixed RDRAND/RDSEED Benchmark Script
Code‚ÄÇ‚àô‚ÄÇVersion 28¬†
// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
#ifdef _MSC_VER
    __cpuid(cpuInfo, 1);
#else
    __asm__ __volatile__ (
        "cpuid"
        : "=a" (cpuInfo[0]), "=b" (cpuInfo[1]), "=c" (cpuInfo[2]), "=d" (cpuInfo[3])
 

Now for the Clang (Windows) issue - it says "not found" but we detected it. Let me check why:

Fixed RDRAND/RDSEED Benchmark Script
Code‚ÄÇ‚àô‚ÄÇVersion 29¬†
# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
Write-Host "  Debug: clangWinPath = '$clangWinPath'" -ForegroundColor Gray
Write-Host "  Debug: Test-Path result = $(Test-Path $clangWi

The main fix is the CPUID code - it now works with both MSVC and GCC/Clang. I also added debug output to see why Clang (Windows) is being skipped.

Run this version and it should:

Fix the compilation errors for GCC and Clang (GNU)
Show us why Clang (Windows) is being skipped with the debug messages
D

Perfect! See results
=====================================================
  BENCHMARK RESULTS SUMMARY
=====================================================
RDRAND Performance (lower is better):
Compiler    Method     RDRAND (ns) Speed (M/s)
--------    ------     ----------- -----------
Clang (GNU) Intrinsic    15,975.90        0.06
Clang (GNU) Inline ASM   16,275.37        0.06
Clang (Win) Inline ASM   16,982.52        0.06
MSVC        Intrinsic    17,724.34        0.06
Clang (Win) Intrinsic    18,099.97        0.06
MASM        Pure ASM     18,174.46        0.06
RDSEED Performance (lower is better):
Compiler    Method     RDSEED (ns) Speed (M/s)
--------    ------     ----------- -----------
Clang (Win) Inline ASM   48,748.75        0.02
Clang (GNU) Inline ASM   49,183.14        0.02
Clang (Win) Intrinsic    80,576.81        0.01
MASM        Pure ASM     80,728.75        0.01
MSVC        Intrinsic    80,964.01        0.01
Clang (GNU) Intrinsic    81,152.18        0.01
=====================================================
Fastest RDRAND: Clang (GNU) (Intrinsic) - 15,975.90 ns/call
Fastest RDSEED: Clang (Win) (Inline ASM) - 48,748.75 ns/call
=====================================================
Done! Executables and source files saved in current directory.

Show more

Excellent! The benchmark worked perfectly! Here are the key insights from your results:

üèÜ Performance Summary
RDRAND (64-bit random numbers):
Clang (GNU) Intrinsic - 15,976 ns - FASTEST ‚úì
Clang (GNU) Inline ASM - 16,275 ns
Clang (Win) Inline ASM - 16,983 ns
MSVC Intrinsic - 17,724 ns
Clang (Win) Intrinsic - 18,100 ns
MASM Pure ASM - 18,174 ns
RDSEED (64-bit seed values):
Clang (Win) Inline ASM - 48,749 ns - FASTEST ‚úì
Clang (GNU) Inline ASM - 49,183 ns
Clang (Win) Intrinsic - 80,577 ns
MASM Pure ASM - 80,729 ns
MSVC Intrinsic - 80,964 ns
Clang (GNU) Intrinsic - 81,152 ns
üìä Key Findings:
RDSEED is ~3-5x slower than RDRAND - This is expected as RDSEED provides true entropy while RDRAND uses a DRBG
Inline Assembly is MUCH faster for RDSEED (48-49k ns vs 80k ns) - Almost 40% faster! This is a significant finding.
For RDRAND, the difference is minimal between methods (~10-15% variation)
Clang (GNU/MSYS2) produces the fastest RDRAND code
Pure MASM assembly is NOT the fastest - Compiler intrinsics/inline ASM can match or beat hand-written assembly
üí° Recommendation:

For optimal performance:

Use Clang (GNU) with intrinsics for RDRAND
Use Clang (Win/GNU) with inline assembly for RDSEED - saves 30+ microseconds per call!

Your CPU's RDRAND/RDSEED are relatively slow (~16-80 microseconds per call), which is normal for these instructions. Would you like me to create an optimized version that uses the fastest method for each instruction?

Claude can make mistakes. Please double-check responses.




Sonnet 4.5


================================================================================
ARTIFACT #2: Fixed RDRAND/RDSEED Benchmark Script
================================================================================

# =====================================================
# Create Fixed Benchmark Source Code
# =====================================================

@"
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

// Include intrin.h for MSVC
#ifdef _MSC_VER
#include <intrin.h>
#endif

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((always_inline))
static inline uint64_t rdrand64_inline_asm() {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((always_inline))
static inline uint64_t rdseed64_inline_asm() {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers) - with retry logic
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    int retries = 0;
    while (!_rdrand64_step(&result)) {
        retries++;
        if (retries > 10) {
            fprintf(stderr, "RDRAND failed after 10 retries\n");
            return 0;
        }
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    int retries = 0;
    while (!_rdseed64_step(&result)) {
        retries++;
        if (retries > 10) {
            fprintf(stderr, "RDSEED failed after 10 retries\n");
            return 0;
        }
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%s:\n", name);
    printf("  Total time: %.6f seconds\n", elapsed);
    printf("  Per call: %.2f ns\n", ns_per_call);
    printf("  Throughput: %.2f million/sec\n", iterations / elapsed / 1e6);
    printf("  Checksum: %llu (prevent optimization)\n\n", sum);
    
    return ns_per_call;
}

int main() {
    const int ITERATIONS = 10000000; // 10 million
    const int RDSEED_ITERATIONS = 1000000; // 1 million (slower)
    
    printf("====================================================\n");
    printf("     RDRAND/RDSEED Performance Benchmark\n");
    printf("====================================================\n\n");
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d\n", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s\n", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d\n", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    
    printf("Iterations (RDRAND): %d\n", ITERATIONS);
    printf("Iterations (RDSEED): %d\n\n", RDSEED_ITERATIONS);
    
    printf("====================================================\n");
    printf("RDRAND64 Performance\n");
    printf("====================================================\n\n");
    
    double intrinsic_time = benchmark("RDRAND64 (intrinsic _rdrand64_step)", rdrand64_intrinsic, ITERATIONS);
    
#if defined(__clang__) || defined(__GNUC__)
    double inline_asm_time = benchmark("RDRAND64 (inline assembly)", rdrand64_inline_asm, ITERATIONS);
#endif
    
    printf("====================================================\n");
    printf("RDSEED64 Performance\n");
    printf("====================================================\n\n");
    
    double rdseed_intrinsic_time = benchmark("RDSEED64 (intrinsic _rdseed64_step)", rdseed64_intrinsic, RDSEED_ITERATIONS);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdseed_inline_asm_time = benchmark("RDSEED64 (inline assembly)", rdseed64_inline_asm, RDSEED_ITERATIONS);
#endif
    
    printf("====================================================\n");
    printf("Summary\n");
    printf("====================================================\n\n");
    
#if defined(__clang__) || defined(__GNUC__)
    printf("RDRAND64:\n");
    printf("  Intrinsic: %.2f ns/call\n", intrinsic_time);
    printf("  Inline ASM: %.2f ns/call\n", inline_asm_time);
    printf("  Difference: %.2f%% (%s)\n\n", 
           fabs(inline_asm_time - intrinsic_time) / intrinsic_time * 100,
           inline_asm_time < intrinsic_time ? "inline ASM faster" : "intrinsic faster");
    
    printf("RDSEED64:\n");
    printf("  Intrinsic: %.2f ns/call\n", rdseed_intrinsic_time);
    printf("  Inline ASM: %.2f ns/call\n", rdseed_inline_asm_time);
    printf("  Difference: %.2f%% (%s)\n\n", 
           fabs(rdseed_inline_asm_time - rdseed_intrinsic_time) / rdseed_intrinsic_time * 100,
           rdseed_inline_asm_time < rdseed_intrinsic_time ? "inline ASM faster" : "intrinsic faster");
    
    printf("RDRAND vs RDSEED:\n");
    printf("  RDSEED is %.2fx slower than RDRAND\n", rdseed_intrinsic_time / intrinsic_time);
#else
    printf("Note: Inline assembly comparison only available with Clang/GCC\n");
    printf("MSVC does not support inline assembly in x64 mode.\n\n");
    printf("RDRAND64 intrinsic: %.2f ns/call\n", intrinsic_time);
    printf("RDSEED64 intrinsic: %.2f ns/call\n", rdseed_intrinsic_time);
    printf("RDSEED is %.2fx slower than RDRAND\n", rdseed_intrinsic_time / intrinsic_time);
#endif
    
    return 0;
}
"@ | Out-File -Encoding ASCII benchmark_comprehensive_fixed.c

Write-Host "=====================================================" -ForegroundColor Cyan
Write-Host "  Fixed RDRAND/RDSEED Benchmark" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Test with MSVC
Write-Host "`n=== Compiling with MSVC ===" -ForegroundColor Yellow
cl /O2 benchmark_comprehensive_fixed.c /Fe:benchmark_msvc_fixed.exe /nologo 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "[OK] MSVC compilation successful" -ForegroundColor Green
    Write-Host "`nRunning MSVC benchmark..." -ForegroundColor Cyan
    .\benchmark_msvc_fixed.exe
} else {
    Write-Host "[ERROR] MSVC compilation failed" -ForegroundColor Red
}



================================================================================
ARTIFACT #3: Code
================================================================================

# =====================================================
# Create Fixed Benchmark Source Code
# =====================================================

@"
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

// Include intrin.h for MSVC
#ifdef _MSC_VER
#include <intrin.h>
#endif

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((always_inline))
static inline uint64_t rdrand64_inline_asm() {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((always_inline))
static inline uint64_t rdseed64_inline_asm() {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers) - with retry logic
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    int retries = 0;
    while (!_rdrand64_step(&result)) {
        retries++;
        if (retries > 10) {
            fprintf(stderr, "RDRAND failed after 10 retries\n");
            return 0;
        }
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    int retries = 0;
    while (!_rdseed64_step(&result)) {
        retries++;
        if (retries > 10) {
            fprintf(stderr, "RDSEED failed after 10 retries\n");
            return 0;
        }
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%s:\n", name);
    printf("  Total time: %.6f seconds\n", elapsed);
    printf("  Per call: %.2f ns\n", ns_per_call);
    printf("  Throughput: %.2f million/sec\n", iterations / elapsed / 1e6);
    printf("  Checksum: %llu (prevent optimization)\n\n", sum);
    
    return ns_per_call;
}

int main() {
    const int ITERATIONS = 10000000; // 10 million
    const int RDSEED_ITERATIONS = 1000000; // 1 million (slower)
    
    printf("====================================================\n");
    printf("     RDRAND/RDSEED Performance Benchmark\n");
    printf("====================================================\n\n");
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d\n", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s\n", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d\n", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    
    printf("Iterations (RDRAND): %d\n", ITERATIONS);
    printf("Iterations (RDSEED): %d\n\n", RDSEED_ITERATIONS);
    
    printf("====================================================\n");
    printf("RDRAND64 Performance\n");
    printf("====================================================\n\n");
    
    double intrinsic_time = benchmark("RDRAND64 (intrinsic _rdrand64_step)", rdrand64_intrinsic, ITERATIONS);
    
#if defined(__clang__) || defined(__GNUC__)
    double inline_asm_time = benchmark("RDRAND64 (inline assembly)", rdrand64_inline_asm, ITERATIONS);
#endif
    
    printf("====================================================\n");
    printf("RDSEED64 Performance\n");
    printf("====================================================\n\n");
    
    double rdseed_intrinsic_time = benchmark("RDSEED64 (intrinsic _rdseed64_step)", rdseed64_intrinsic, RDSEED_ITERATIONS);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdseed_inline_asm_time = benchmark("RDSEED64 (inline assembly)", rdseed64_inline_asm, RDSEED_ITERATIONS);
#endif
    
    printf("====================================================\n");
    printf("Summary\n");
    printf("====================================================\n\n");
    
#if defined(__clang__) || defined(__GNUC__)
    printf("RDRAND64:\n");
    printf("  Intrinsic: %.2f ns/call\n", intrinsic_time);
    printf("  Inline ASM: %.2f ns/call\n", inline_asm_time);
    printf("  Difference: %.2f%% (%s)\n\n", 
           fabs(inline_asm_time - intrinsic_time) / intrinsic_time * 100,
           inline_asm_time < intrinsic_time ? "inline ASM faster" : "intrinsic faster");
    
    printf("RDSEED64:\n");
    printf("  Intrinsic: %.2f ns/call\n", rdseed_intrinsic_time);
    printf("  Inline ASM: %.2f ns/call\n", rdseed_inline_asm_time);
    printf("  Difference: %.2f%% (%s)\n\n", 
           fabs(rdseed_inline_asm_time - rdseed_intrinsic_time) / rdseed_intrinsic_time * 100,
           rdseed_inline_asm_time < rdseed_intrinsic_time ? "inline ASM faster" : "intrinsic faster");
    
    printf("RDRAND vs RDSEED:\n");
    printf("  RDSEED is %.2fx slower than RDRAND\n", rdseed_intrinsic_time / intrinsic_time);
#else
    printf("Note: Inline assembly comparison only available with Clang/GCC\n");
    printf("MSVC does not support inline assembly in x64 mode.\n\n");
    printf("RDRAND64 intrinsic: %.2f ns/call\n", intrinsic_time);
    printf("RDSEED64 intrinsic: %.2f ns/call\n", rdseed_intrinsic_time);
    printf("RDSEED is %.2fx slower than RDRAND\n", rdseed_intrinsic_time / intrinsic_time);
#endif
    
    return 0;
}
"@ | Out-File -Encoding ASCII benchmark_comprehensive_fixed.c

Write-Host "=====================================================" -ForegroundColor Cyan
Write-Host "  Fixed RDRAND/RDSEED Benchmark" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Test with MSVC
Write-Host "`n=== Compiling with MSVC ===" -ForegroundColor Yellow
cl /O2 benchmark_comprehensive_fixed.c /Fe:benchmark_msvc_fixed.exe /nologo 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "[OK] MSVC compilation successful" -ForegroundColor Green
    Write-Host "`nRunning MSVC benchmark..." -ForegroundColor Cyan
    .\benchmark_msvc_fixed.exe
} else {
    Write-Host "[ERROR] MSVC compilation failed" -ForegroundColor Red
}



================================================================================
ARTIFACT #4: Fixed RDRAND/RDSEED Benchmark Script
================================================================================

# =====================================================
# Create Enhanced Benchmark with CPU Detection
# =====================================================

@"
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Intrinsic version with limited retries
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    int retries = 0;
    while (!_rdrand64_step(&result)) {
        retries++;
        if (retries > 100) {
            fprintf(stderr, "ERROR: RDRAND failed after 100 retries\n");
            return 0;
        }
    }
    return result;
}

uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    int retries = 0;
    while (!_rdseed64_step(&result)) {
        retries++;
        if (retries > 1000) {
            fprintf(stderr, "ERROR: RDSEED failed after 1000 retries\n");
            return 0;
        }
        _mm_pause();
    }
    return result;
}

// Benchmark function with progress indicators
double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("%s:\n", name);
    printf("  Warming up (1000 calls)...");
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) {
        uint64_t val = func();
        if (val == 0 && i < 10) {
            printf("\n  ERROR: Function returned 0 during warmup\n");
            return -1.0;
        }
    }
    printf(" done\n");
    fflush(stdout);
    
    printf("  Running benchmark...");
    fflush(stdout);
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    int progress_interval = iterations / 10;
    
    for (int i = 0; i < iterations; i++) {
        sum += func();
        
        if (progress_interval > 0 && i > 0 && i % progress_interval == 0) {
            printf(".");
            fflush(stdout);
        }
    }
    
    QueryPerformanceCounter(&end);
    
    printf(" done\n");
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("  Total time: %.6f seconds\n", elapsed);
    printf("  Per call: %.2f ns\n", ns_per_call);
    printf("  Throughput: %.2f million/sec\n", iterations / elapsed / 1e6);
    printf("  Checksum: %llu\n\n", sum);
    
    return ns_per_call;
}

int main() {
    printf("====================================================\n");
    printf("     RDRAND/RDSEED Performance Benchmark\n");
    printf("====================================================\n\n");
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d\n", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s\n", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d\n", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    
    printf("\nChecking CPU features...\n");
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    printf("  RDRAND support: %s\n", has_rdrand ? "YES" : "NO");
    printf("  RDSEED support: %s\n\n", has_rdseed ? "YES" : "NO");
    
    if (!has_rdrand) {
        printf("ERROR: Your CPU does not support RDRAND instruction!\n");
        printf("This benchmark requires a CPU with RDRAND support.\n");
        return 1;
    }
    
    printf("====================================================\n");
    printf("Testing RDRAND (quick test)\n");
    printf("====================================================\n\n");
    
    printf("Generating 10 random values...\n");
    for (int i = 0; i < 10; i++) {
        uint64_t val = rdrand64_intrinsic();
        printf("  %2d: 0x%016llX\n", i + 1, val);
    }
    printf("\n");
    
    const int RDRAND_ITERATIONS = 1000000;  // Start with 1 million
    const int RDSEED_ITERATIONS = 100000;   // Start with 100k
    
    printf("====================================================\n");
    printf("RDRAND64 Performance (%d iterations)\n", RDRAND_ITERATIONS);
    printf("====================================================\n\n");
    
    double rdrand_time = benchmark("RDRAND64 (intrinsic _rdrand64_step)", 
                                    rdrand64_intrinsic, RDRAND_ITERATIONS);
    
    if (rdrand_time < 0) {
        printf("ERROR: RDRAND benchmark failed!\n");
        return 1;
    }
    
    if (has_rdseed) {
        printf("====================================================\n");
        printf("RDSEED64 Performance (%d iterations)\n", RDSEED_ITERATIONS);
        printf("====================================================\n\n");
        
        double rdseed_time = benchmark("RDSEED64 (intrinsic _rdseed64_step)", 
                                        rdseed64_intrinsic, RDSEED_ITERATIONS);
        
        if (rdseed_time > 0) {
            printf("====================================================\n");
            printf("Summary\n");
            printf("====================================================\n\n");
            printf("RDRAND64: %.2f ns/call\n", rdrand_time);
            printf("RDSEED64: %.2f ns/call\n", rdseed_time);
            printf("RDSEED is %.2fx slower than RDRAND\n", rdseed_time / rdrand_time);
        }
    } else {
        printf("====================================================\n");
        printf("Note: RDSEED not supported on this CPU\n");
        printf("====================================================\n\n");
        printf("RDRAND64: %.2f ns/call\n", rdrand_time);
    }
    
    return 0;
}
"@ | Out-File -Encoding ASCII benchmark_comprehensive_fixed.c

Write-Host "=====================================================" -ForegroundColor Cyan
Write-Host "  Enhanced RDRAND/RDSEED Benchmark" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Test with MSVC
Write-Host "`n=== Compiling with MSVC ===" -ForegroundColor Yellow
cl /O2 benchmark_comprehensive_fixed.c /Fe:benchmark_msvc_fixed.exe /nologo 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "[OK] MSVC compilation successful" -ForegroundColor Green
    Write-Host "`nRunning MSVC benchmark..." -ForegroundColor Cyan
    Write-Host "(Press Ctrl+C if it hangs)" -ForegroundColor Yellow
    .\benchmark_msvc_fixed.exe
} else {
    Write-Host "[ERROR] MSVC compilation failed" -ForegroundColor Red
}



================================================================================
ARTIFACT #5: Code‚ÄÇ‚àô‚ÄÇVersion 2
================================================================================

# =====================================================
# Create Enhanced Benchmark with CPU Detection
# =====================================================

@"
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Intrinsic version with limited retries
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    int retries = 0;
    while (!_rdrand64_step(&result)) {
        retries++;
        if (retries > 100) {
            fprintf(stderr, "ERROR: RDRAND failed after 100 retries\n");
            return 0;
        }
    }
    return result;
}

uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    int retries = 0;
    while (!_rdseed64_step(&result)) {
        retries++;
        if (retries > 1000) {
            fprintf(stderr, "ERROR: RDSEED failed after 1000 retries\n");
            return 0;
        }
        _mm_pause();
    }
    return result;
}

// Benchmark function with progress indicators
double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("%s:\n", name);
    printf("  Warming up (1000 calls)...");
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) {
        uint64_t val = func();
        if (val == 0 && i < 10) {
            printf("\n  ERROR: Function returned 0 during warmup\n");
            return -1.0;
        }
    }
    printf(" done\n");
    fflush(stdout);
    
    printf("  Running benchmark...");
    fflush(stdout);
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    int progress_interval = iterations / 10;
    
    for (int i = 0; i < iterations; i++) {
        sum += func();
        
        if (progress_interval > 0 && i > 0 && i % progress_interval == 0) {
            printf(".");
            fflush(stdout);
        }
    }
    
    QueryPerformanceCounter(&end);
    
    printf(" done\n");
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("  Total time: %.6f seconds\n", elapsed);
    printf("  Per call: %.2f ns\n", ns_per_call);
    printf("  Throughput: %.2f million/sec\n", iterations / elapsed / 1e6);
    printf("  Checksum: %llu\n\n", sum);
    
    return ns_per_call;
}

int main() {
    printf("====================================================\n");
    printf("     RDRAND/RDSEED Performance Benchmark\n");
    printf("====================================================\n\n");
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d\n", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s\n", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d\n", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    
    printf("\nChecking CPU features...\n");
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    printf("  RDRAND support: %s\n", has_rdrand ? "YES" : "NO");
    printf("  RDSEED support: %s\n\n", has_rdseed ? "YES" : "NO");
    
    if (!has_rdrand) {
        printf("ERROR: Your CPU does not support RDRAND instruction!\n");
        printf("This benchmark requires a CPU with RDRAND support.\n");
        return 1;
    }
    
    printf("====================================================\n");
    printf("Testing RDRAND (quick test)\n");
    printf("====================================================\n\n");
    
    printf("Generating 10 random values...\n");
    for (int i = 0; i < 10; i++) {
        uint64_t val = rdrand64_intrinsic();
        printf("  %2d: 0x%016llX\n", i + 1, val);
    }
    printf("\n");
    
    const int RDRAND_ITERATIONS = 1000000;  // Start with 1 million
    const int RDSEED_ITERATIONS = 100000;   // Start with 100k
    
    printf("====================================================\n");
    printf("RDRAND64 Performance (%d iterations)\n", RDRAND_ITERATIONS);
    printf("====================================================\n\n");
    
    double rdrand_time = benchmark("RDRAND64 (intrinsic _rdrand64_step)", 
                                    rdrand64_intrinsic, RDRAND_ITERATIONS);
    
    if (rdrand_time < 0) {
        printf("ERROR: RDRAND benchmark failed!\n");
        return 1;
    }
    
    if (has_rdseed) {
        printf("====================================================\n");
        printf("RDSEED64 Performance (%d iterations)\n", RDSEED_ITERATIONS);
        printf("====================================================\n\n");
        
        double rdseed_time = benchmark("RDSEED64 (intrinsic _rdseed64_step)", 
                                        rdseed64_intrinsic, RDSEED_ITERATIONS);
        
        if (rdseed_time > 0) {
            printf("====================================================\n");
            printf("Summary\n");
            printf("====================================================\n\n");
            printf("RDRAND64: %.2f ns/call\n", rdrand_time);
            printf("RDSEED64: %.2f ns/call\n", rdseed_time);
            printf("RDSEED is %.2fx slower than RDRAND\n", rdseed_time / rdrand_time);
        }
    } else {
        printf("====================================================\n");
        printf("Note: RDSEED not supported on this CPU\n");
        printf("====================================================\n\n");
        printf("RDRAND64: %.2f ns/call\n", rdrand_time);
    }
    
    return 0;
}
"@ | Out-File -Encoding ASCII benchmark_comprehensive_fixed.c

Write-Host "=====================================================" -ForegroundColor Cyan
Write-Host "  Enhanced RDRAND/RDSEED Benchmark" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Test with MSVC
Write-Host "`n=== Compiling with MSVC ===" -ForegroundColor Yellow
cl /O2 benchmark_comprehensive_fixed.c /Fe:benchmark_msvc_fixed.exe /nologo 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "[OK] MSVC compilation successful" -ForegroundColor Green
    Write-Host "`nRunning MSVC benchmark..." -ForegroundColor Cyan
    Write-Host "(Press Ctrl+C if it hangs)" -ForegroundColor Yellow
    .\benchmark_msvc_fixed.exe
} else {
    Write-Host "[ERROR] MSVC compilation failed" -ForegroundColor Red
}



================================================================================
ARTIFACT #6: Fixed RDRAND/RDSEED Benchmark Script
================================================================================

# =====================================================
# Create Enhanced Benchmark with CPU Detection
# =====================================================

@"
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Intrinsic version with limited retries
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    int retries = 0;
    while (!_rdrand64_step(&result)) {
        retries++;
        if (retries > 100) {
            fprintf(stderr, "ERROR: RDRAND failed after 100 retries\n");
            return 0;
        }
    }
    return result;
}

uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    int retries = 0;
    while (!_rdseed64_step(&result)) {
        retries++;
        if (retries > 1000) {
            fprintf(stderr, "ERROR: RDSEED failed after 1000 retries\n");
            return 0;
        }
        _mm_pause();
    }
    return result;
}

// Benchmark function with progress indicators
double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("%s:\n", name);
    printf("  Warming up (1000 calls)...");
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) {
        uint64_t val = func();
        if (val == 0 && i < 10) {
            printf("\n  ERROR: Function returned 0 during warmup\n");
            return -1.0;
        }
    }
    printf(" done\n");
    fflush(stdout);
    
    printf("  Running benchmark...");
    fflush(stdout);
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    int progress_interval = iterations / 10;
    
    for (int i = 0; i < iterations; i++) {
        sum += func();
        
        if (progress_interval > 0 && i > 0 && i % progress_interval == 0) {
            printf(".");
            fflush(stdout);
        }
    }
    
    QueryPerformanceCounter(&end);
    
    printf(" done\n");
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("  Total time: %.6f seconds\n", elapsed);
    printf("  Per call: %.2f ns\n", ns_per_call);
    printf("  Throughput: %.2f million/sec\n", iterations / elapsed / 1e6);
    printf("  Checksum: %llu\n\n", sum);
    
    return ns_per_call;
}

int main() {
    printf("====================================================\n");
    printf("     RDRAND/RDSEED Performance Benchmark\n");
    printf("====================================================\n\n");
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d\n", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s\n", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d\n", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    
    printf("\nChecking CPU features...\n");
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    printf("  RDRAND support: %s\n", has_rdrand ? "YES" : "NO");
    printf("  RDSEED support: %s\n\n", has_rdseed ? "YES" : "NO");
    
    if (!has_rdrand) {
        printf("ERROR: Your CPU does not support RDRAND instruction!\n");
        printf("This benchmark requires a CPU with RDRAND support.\n");
        return 1;
    }
    
    printf("====================================================\n");
    printf("Testing RDRAND (quick test)\n");
    printf("====================================================\n\n");
    
    printf("Generating 10 random values...\n");
    for (int i = 0; i < 10; i++) {
        uint64_t val = rdrand64_intrinsic();
        printf("  %2d: 0x%016llX\n", i + 1, val);
    }
    printf("\n");
    
    const int RDRAND_ITERATIONS = 1000000;  // Start with 1 million
    const int RDSEED_ITERATIONS = 100000;   // Start with 100k
    
    printf("====================================================\n");
    printf("RDRAND64 Performance (%d iterations)\n", RDRAND_ITERATIONS);
    printf("====================================================\n\n");
    
    double rdrand_time = benchmark("RDRAND64 (intrinsic _rdrand64_step)", 
                                    rdrand64_intrinsic, RDRAND_ITERATIONS);
    
    if (rdrand_time < 0) {
        printf("ERROR: RDRAND benchmark failed!\n");
        return 1;
    }
    
    if (has_rdseed) {
        printf("====================================================\n");
        printf("RDSEED64 Performance (%d iterations)\n", RDSEED_ITERATIONS);
        printf("====================================================\n\n");
        
        double rdseed_time = benchmark("RDSEED64 (intrinsic _rdseed64_step)", 
                                        rdseed64_intrinsic, RDSEED_ITERATIONS);
        
        if (rdseed_time > 0) {
            printf("====================================================\n");
            printf("Summary\n");
            printf("====================================================\n\n");
            printf("RDRAND64: %.2f ns/call\n", rdrand_time);
            printf("RDSEED64: %.2f ns/call\n", rdseed_time);
            printf("RDSEED is %.2fx slower than RDRAND\n", rdseed_time / rdrand_time);
        }
    } else {
        printf("====================================================\n");
        printf("Note: RDSEED not supported on this CPU\n");
        printf("====================================================\n\n");
        printf("RDRAND64: %.2f ns/call\n", rdrand_time);
    }
    
    return 0;
}
"@ | Out-File -Encoding ASCII benchmark_comprehensive_fixed.c

Write-Host "=====================================================" -ForegroundColor Cyan
Write-Host "  Enhanced RDRAND/RDSEED Benchmark" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Test with MSVC
Write-Host "`n=== Compiling with MSVC ===" -ForegroundColor Yellow
cl /O2 benchmark_comprehensive_fixed.c /Fe:benchmark_msvc_fixed.exe /nologo 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "[OK] MSVC compilation successful" -ForegroundColor Green
    Write-Host "`nRunning MSVC benchmark..." -ForegroundColor Cyan
    Write-Host "(Press Ctrl+C if it hangs)" -ForegroundColor Yellow
    .\benchmark_msvc_fixed.exe
} else {
    Write-Host "[ERROR] MSVC compilation failed" -ForegroundColor Red
}



================================================================================
ARTIFACT #7: Code‚ÄÇ‚àô‚ÄÇVersion 3
================================================================================

# =====================================================
# Create Enhanced Benchmark with CPU Detection
# =====================================================

@"
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Intrinsic version with limited retries
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    int retries = 0;
    while (!_rdrand64_step(&result)) {
        retries++;
        if (retries > 100) {
            fprintf(stderr, "ERROR: RDRAND failed after 100 retries\n");
            return 0;
        }
    }
    return result;
}

uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    int retries = 0;
    while (!_rdseed64_step(&result)) {
        retries++;
        if (retries > 1000) {
            fprintf(stderr, "ERROR: RDSEED failed after 1000 retries\n");
            return 0;
        }
        _mm_pause();
    }
    return result;
}

// Benchmark function with progress indicators
double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("%s:\n", name);
    printf("  Warming up (1000 calls)...");
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) {
        uint64_t val = func();
        if (val == 0 && i < 10) {
            printf("\n  ERROR: Function returned 0 during warmup\n");
            return -1.0;
        }
    }
    printf(" done\n");
    fflush(stdout);
    
    printf("  Running benchmark...");
    fflush(stdout);
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    int progress_interval = iterations / 10;
    
    for (int i = 0; i < iterations; i++) {
        sum += func();
        
        if (progress_interval > 0 && i > 0 && i % progress_interval == 0) {
            printf(".");
            fflush(stdout);
        }
    }
    
    QueryPerformanceCounter(&end);
    
    printf(" done\n");
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("  Total time: %.6f seconds\n", elapsed);
    printf("  Per call: %.2f ns\n", ns_per_call);
    printf("  Throughput: %.2f million/sec\n", iterations / elapsed / 1e6);
    printf("  Checksum: %llu\n\n", sum);
    
    return ns_per_call;
}

int main() {
    printf("====================================================\n");
    printf("     RDRAND/RDSEED Performance Benchmark\n");
    printf("====================================================\n\n");
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d\n", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s\n", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d\n", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    
    printf("\nChecking CPU features...\n");
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    printf("  RDRAND support: %s\n", has_rdrand ? "YES" : "NO");
    printf("  RDSEED support: %s\n\n", has_rdseed ? "YES" : "NO");
    
    if (!has_rdrand) {
        printf("ERROR: Your CPU does not support RDRAND instruction!\n");
        printf("This benchmark requires a CPU with RDRAND support.\n");
        return 1;
    }
    
    printf("====================================================\n");
    printf("Testing RDRAND (quick test)\n");
    printf("====================================================\n\n");
    
    printf("Generating 10 random values...\n");
    for (int i = 0; i < 10; i++) {
        uint64_t val = rdrand64_intrinsic();
        printf("  %2d: 0x%016llX\n", i + 1, val);
    }
    printf("\n");
    
    const int RDRAND_ITERATIONS = 1000000;  // Start with 1 million
    const int RDSEED_ITERATIONS = 100000;   // Start with 100k
    
    printf("====================================================\n");
    printf("RDRAND64 Performance (%d iterations)\n", RDRAND_ITERATIONS);
    printf("====================================================\n\n");
    
    double rdrand_time = benchmark("RDRAND64 (intrinsic _rdrand64_step)", 
                                    rdrand64_intrinsic, RDRAND_ITERATIONS);
    
    if (rdrand_time < 0) {
        printf("ERROR: RDRAND benchmark failed!\n");
        return 1;
    }
    
    if (has_rdseed) {
        printf("====================================================\n");
        printf("RDSEED64 Performance (%d iterations)\n", RDSEED_ITERATIONS);
        printf("====================================================\n\n");
        
        double rdseed_time = benchmark("RDSEED64 (intrinsic _rdseed64_step)", 
                                        rdseed64_intrinsic, RDSEED_ITERATIONS);
        
        if (rdseed_time > 0) {
            printf("====================================================\n");
            printf("Summary\n");
            printf("====================================================\n\n");
            printf("RDRAND64: %.2f ns/call\n", rdrand_time);
            printf("RDSEED64: %.2f ns/call\n", rdseed_time);
            printf("RDSEED is %.2fx slower than RDRAND\n", rdseed_time / rdrand_time);
        }
    } else {
        printf("====================================================\n");
        printf("Note: RDSEED not supported on this CPU\n");
        printf("====================================================\n\n");
        printf("RDRAND64: %.2f ns/call\n", rdrand_time);
    }
    
    return 0;
}
"@ | Out-File -Encoding ASCII benchmark_comprehensive_fixed.c

Write-Host "=====================================================" -ForegroundColor Cyan
Write-Host "  Enhanced RDRAND/RDSEED Benchmark" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Test with MSVC
Write-Host "`n=== Compiling with MSVC ===" -ForegroundColor Yellow
cl /O2 benchmark_comprehensive_fixed.c /Fe:benchmark_msvc_fixed.exe /nologo 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "[OK] MSVC compilation successful" -ForegroundColor Green
    Write-Host "`nRunning MSVC benchmark..." -ForegroundColor Cyan
    Write-Host "(Press Ctrl+C if it hangs)" -ForegroundColor Yellow
    .\benchmark_msvc_fixed.exe
} else {
    Write-Host "[ERROR] MSVC compilation failed" -ForegroundColor Red
}



================================================================================
ARTIFACT #8: Fixed RDRAND/RDSEED Benchmark Script
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

# Create C source code with all implementations
@"
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
"@
Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
@"
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
"@
Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
@"
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
"@
Out-File -Encoding ASCII -FilePath benchmark_masm.c

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/5] Testing MSVC..." -ForegroundColor Yellow
cl /O2 /nologo benchmark_multi.c /Fe:benchmark_msvc.exe 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_msvc.exe
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    
    $results += [PSCustomObject]@{
        Compiler = "MSVC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows)
Write-Host "`n[2/5] Testing Clang (Windows)..." -ForegroundColor Yellow
clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Inline ASM"
        RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
        RDSEED_ns = 0
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test GCC (if available via MinGW/MSYS2)
Write-Host "`n[3/5] Testing GCC..." -ForegroundColor Yellow
gcc -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_gcc.exe
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Inline ASM"
        RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
        RDSEED_ns = 0
    }
} else {
    Write-Host "  Compilation: FAILED (GCC not found or not in PATH)" -ForegroundColor Red
}

# Test MASM
Write-Host "`n[4/5] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
ml64 /c /nologo rdrand_asm.asm 2>$null
if ($LASTEXITCODE -eq 0) {
    cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /Fe:benchmark_masm.exe 2>$null
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #9: Code‚ÄÇ‚àô‚ÄÇVersion 4
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

# Create C source code with all implementations
@"
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
"@
Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
@"
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
"@
Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
@"
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
"@
Out-File -Encoding ASCII -FilePath benchmark_masm.c

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/5] Testing MSVC..." -ForegroundColor Yellow
cl /O2 /nologo benchmark_multi.c /Fe:benchmark_msvc.exe 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_msvc.exe
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    
    $results += [PSCustomObject]@{
        Compiler = "MSVC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows)
Write-Host "`n[2/5] Testing Clang (Windows)..." -ForegroundColor Yellow
clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Inline ASM"
        RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
        RDSEED_ns = 0
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test GCC (if available via MinGW/MSYS2)
Write-Host "`n[3/5] Testing GCC..." -ForegroundColor Yellow
gcc -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_gcc.exe
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Inline ASM"
        RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
        RDSEED_ns = 0
    }
} else {
    Write-Host "  Compilation: FAILED (GCC not found or not in PATH)" -ForegroundColor Red
}

# Test MASM
Write-Host "`n[4/5] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
ml64 /c /nologo rdrand_asm.asm 2>$null
if ($LASTEXITCODE -eq 0) {
    cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /Fe:benchmark_masm.exe 2>$null
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #10: Fixed RDRAND/RDSEED Benchmark Script
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

# Create C source code with all implementations
@"
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
"@
Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
@"
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
"@
Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
@"
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
"@
Out-File -Encoding ASCII -FilePath benchmark_masm.c

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/5] Testing MSVC..." -ForegroundColor Yellow
cl /O2 /nologo benchmark_multi.c /Fe:benchmark_msvc.exe 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_msvc.exe
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    
    $results += [PSCustomObject]@{
        Compiler = "MSVC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
# Try to find MSYS2 clang
$msys2Paths = @(
    "C:\msys64\mingw64\bin\clang.exe",
    "C:\msys64\clang64\bin\clang.exe",
    "C:\msys64\ucrt64\bin\clang.exe"
)
$msys2Clang = $null
foreach ($path in $msys2Paths) {
    if (Test-Path $path) {
        $msys2Clang = $path
        break
    }
}

if ($msys2Clang) {
    & $msys2Clang -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>$null
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK (found at $msys2Clang)" -ForegroundColor Green
        $output = & .\benchmark_clang_gnu.exe
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        $results += [PSCustomObject]@{
            Compiler = "Clang (GNU)"
            Method = "Intrinsic"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
        
        if ($rdrand_asm_speedup -ne 1) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Inline ASM"
                RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Compilation: SKIPPED (MSYS2 Clang not found in standard locations)" -ForegroundColor Yellow
    Write-Host "  Checked: C:\msys64\mingw64\bin, C:\msys64\clang64\bin, C:\msys64\ucrt64\bin" -ForegroundColor Gray
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
gcc -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_gcc.exe
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Inline ASM"
        RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
        RDSEED_ns = 0
    }
} else {
    Write-Host "  Compilation: FAILED (GCC not found or not in PATH)" -ForegroundColor Red
}

# Test MASM
Write-Host "`n[4/5] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
ml64 /c /nologo rdrand_asm.asm 2>$null
if ($LASTEXITCODE -eq 0) {
    cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /Fe:benchmark_masm.exe 2>$null
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #11: Code‚ÄÇ‚àô‚ÄÇVersion 5
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

# Create C source code with all implementations
@"
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
"@
Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
@"
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
"@
Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
@"
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
"@
Out-File -Encoding ASCII -FilePath benchmark_masm.c

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/5] Testing MSVC..." -ForegroundColor Yellow
cl /O2 /nologo benchmark_multi.c /Fe:benchmark_msvc.exe 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_msvc.exe
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    
    $results += [PSCustomObject]@{
        Compiler = "MSVC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
# Try to find MSYS2 clang
$msys2Paths = @(
    "C:\msys64\mingw64\bin\clang.exe",
    "C:\msys64\clang64\bin\clang.exe",
    "C:\msys64\ucrt64\bin\clang.exe"
)
$msys2Clang = $null
foreach ($path in $msys2Paths) {
    if (Test-Path $path) {
        $msys2Clang = $path
        break
    }
}

if ($msys2Clang) {
    & $msys2Clang -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>$null
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK (found at $msys2Clang)" -ForegroundColor Green
        $output = & .\benchmark_clang_gnu.exe
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        $results += [PSCustomObject]@{
            Compiler = "Clang (GNU)"
            Method = "Intrinsic"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
        
        if ($rdrand_asm_speedup -ne 1) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Inline ASM"
                RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Compilation: SKIPPED (MSYS2 Clang not found in standard locations)" -ForegroundColor Yellow
    Write-Host "  Checked: C:\msys64\mingw64\bin, C:\msys64\clang64\bin, C:\msys64\ucrt64\bin" -ForegroundColor Gray
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
gcc -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_gcc.exe
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Inline ASM"
        RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
        RDSEED_ns = 0
    }
} else {
    Write-Host "  Compilation: FAILED (GCC not found or not in PATH)" -ForegroundColor Red
}

# Test MASM
Write-Host "`n[4/5] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
ml64 /c /nologo rdrand_asm.asm 2>$null
if ($LASTEXITCODE -eq 0) {
    cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /Fe:benchmark_masm.exe 2>$null
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #12: Fixed RDRAND/RDSEED Benchmark Script
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

# Create C source code with all implementations
@"
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
"@
Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
@"
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
"@
Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
@"
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
"@
Out-File -Encoding ASCII -FilePath benchmark_masm.c

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
cl /O2 /nologo benchmark_multi.c /Fe:benchmark_msvc.exe 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_msvc.exe
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    
    $results += [PSCustomObject]@{
        Compiler = "MSVC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
# Try to find MSYS2 clang
$msys2Paths = @(
    "C:\msys64\mingw64\bin\clang.exe",
    "C:\msys64\clang64\bin\clang.exe",
    "C:\msys64\ucrt64\bin\clang.exe"
)
$msys2Clang = $null
foreach ($path in $msys2Paths) {
    if (Test-Path $path) {
        $msys2Clang = $path
        break
    }
}

if ($msys2Clang) {
    & $msys2Clang -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>$null
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK (found at $msys2Clang)" -ForegroundColor Green
        $output = & .\benchmark_clang_gnu.exe
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        $results += [PSCustomObject]@{
            Compiler = "Clang (GNU)"
            Method = "Intrinsic"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
        
        if ($rdrand_asm_speedup -ne 1) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Inline ASM"
                RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Compilation: SKIPPED (MSYS2 Clang not found in standard locations)" -ForegroundColor Yellow
    Write-Host "  Checked: C:\msys64\mingw64\bin, C:\msys64\clang64\bin, C:\msys64\ucrt64\bin" -ForegroundColor Gray
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
gcc -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_gcc.exe
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "GCC"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (GCC not found or not in PATH)" -ForegroundColor Red
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
ml64 /c /nologo rdrand_asm.asm 2>$null
if ($LASTEXITCODE -eq 0) {
    cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /Fe:benchmark_masm.exe 2>$null
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #13: Code‚ÄÇ‚àô‚ÄÇVersion 8
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

# Create C source code with all implementations
@"
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
"@
Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
@"
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
"@
Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
@"
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
"@
Out-File -Encoding ASCII -FilePath benchmark_masm.c

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
cl /O2 /nologo benchmark_multi.c /Fe:benchmark_msvc.exe 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_msvc.exe
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    
    $results += [PSCustomObject]@{
        Compiler = "MSVC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
# Try to find MSYS2 clang
$msys2Paths = @(
    "C:\msys64\mingw64\bin\clang.exe",
    "C:\msys64\clang64\bin\clang.exe",
    "C:\msys64\ucrt64\bin\clang.exe"
)
$msys2Clang = $null
foreach ($path in $msys2Paths) {
    if (Test-Path $path) {
        $msys2Clang = $path
        break
    }
}

if ($msys2Clang) {
    & $msys2Clang -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>$null
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK (found at $msys2Clang)" -ForegroundColor Green
        $output = & .\benchmark_clang_gnu.exe
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        $results += [PSCustomObject]@{
            Compiler = "Clang (GNU)"
            Method = "Intrinsic"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
        
        if ($rdrand_asm_speedup -ne 1) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Inline ASM"
                RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Compilation: SKIPPED (MSYS2 Clang not found in standard locations)" -ForegroundColor Yellow
    Write-Host "  Checked: C:\msys64\mingw64\bin, C:\msys64\clang64\bin, C:\msys64\ucrt64\bin" -ForegroundColor Gray
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
gcc -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>$null
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_gcc.exe
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "GCC"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (GCC not found or not in PATH)" -ForegroundColor Red
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
ml64 /c /nologo rdrand_asm.asm 2>$null
if ($LASTEXITCODE -eq 0) {
    cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /Fe:benchmark_masm.exe 2>$null
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #14: Fixed RDRAND/RDSEED Benchmark Script
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_msvc.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    
    $results += [PSCustomObject]@{
        Compiler = "MSVC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
$msys2Paths = @(
    "C:\msys64\mingw64\bin\clang.exe",
    "C:\msys64\clang64\bin\clang.exe",
    "C:\msys64\ucrt64\bin\clang.exe"
)
$msys2Clang = $null
foreach ($path in $msys2Paths) {
    if (Test-Path $path) {
        $msys2Clang = $path
        break
    }
}

if ($msys2Clang) {
    $null = & $msys2Clang -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK (found at $msys2Clang)" -ForegroundColor Green
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        $results += [PSCustomObject]@{
            Compiler = "Clang (GNU)"
            Method = "Intrinsic"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
        
        if ($rdrand_asm_speedup -ne 1) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Inline ASM"
                RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Compilation: SKIPPED (MSYS2 Clang not found in standard locations)" -ForegroundColor Yellow
    Write-Host "  Checked: C:\msys64\mingw64\bin, C:\msys64\clang64\bin, C:\msys64\ucrt64\bin" -ForegroundColor Gray
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
$null = gcc -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_gcc.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "GCC"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (GCC not found or not in PATH)" -ForegroundColor Red
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #15: Code‚ÄÇ‚àô‚ÄÇVersion 9
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_msvc.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    
    $results += [PSCustomObject]@{
        Compiler = "MSVC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
$msys2Paths = @(
    "C:\msys64\mingw64\bin\clang.exe",
    "C:\msys64\clang64\bin\clang.exe",
    "C:\msys64\ucrt64\bin\clang.exe"
)
$msys2Clang = $null
foreach ($path in $msys2Paths) {
    if (Test-Path $path) {
        $msys2Clang = $path
        break
    }
}

if ($msys2Clang) {
    $null = & $msys2Clang -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK (found at $msys2Clang)" -ForegroundColor Green
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        $results += [PSCustomObject]@{
            Compiler = "Clang (GNU)"
            Method = "Intrinsic"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
        
        if ($rdrand_asm_speedup -ne 1) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Inline ASM"
                RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Compilation: SKIPPED (MSYS2 Clang not found in standard locations)" -ForegroundColor Yellow
    Write-Host "  Checked: C:\msys64\mingw64\bin, C:\msys64\clang64\bin, C:\msys64\ucrt64\bin" -ForegroundColor Gray
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
$null = gcc -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_gcc.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "GCC"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (GCC not found or not in PATH)" -ForegroundColor Red
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #16: Fixed RDRAND/RDSEED Benchmark Script
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    
    $results += [PSCustomObject]@{
        Compiler = "MSVC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
$msys2Paths = @(
    "C:\msys64\mingw64\bin\clang.exe",
    "C:\msys64\clang64\bin\clang.exe",
    "C:\msys64\ucrt64\bin\clang.exe"
)
$msys2Clang = $null
foreach ($path in $msys2Paths) {
    if (Test-Path $path) {
        $msys2Clang = $path
        break
    }
}

if ($msys2Clang) {
    $null = & $msys2Clang -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK (found at $msys2Clang)" -ForegroundColor Green
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        $results += [PSCustomObject]@{
            Compiler = "Clang (GNU)"
            Method = "Intrinsic"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
        
        if ($rdrand_asm_speedup -ne 1) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Inline ASM"
                RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Compilation: SKIPPED (MSYS2 Clang not found in standard locations)" -ForegroundColor Yellow
    Write-Host "  Checked: C:\msys64\mingw64\bin, C:\msys64\clang64\bin, C:\msys64\ucrt64\bin" -ForegroundColor Gray
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
$null = gcc -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_gcc.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "GCC"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (GCC not found or not in PATH)" -ForegroundColor Red
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #17: Code‚ÄÇ‚àô‚ÄÇVersion 10
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    
    $results += [PSCustomObject]@{
        Compiler = "MSVC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
$msys2Paths = @(
    "C:\msys64\mingw64\bin\clang.exe",
    "C:\msys64\clang64\bin\clang.exe",
    "C:\msys64\ucrt64\bin\clang.exe"
)
$msys2Clang = $null
foreach ($path in $msys2Paths) {
    if (Test-Path $path) {
        $msys2Clang = $path
        break
    }
}

if ($msys2Clang) {
    $null = & $msys2Clang -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK (found at $msys2Clang)" -ForegroundColor Green
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        $results += [PSCustomObject]@{
            Compiler = "Clang (GNU)"
            Method = "Intrinsic"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
        
        if ($rdrand_asm_speedup -ne 1) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Inline ASM"
                RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Compilation: SKIPPED (MSYS2 Clang not found in standard locations)" -ForegroundColor Yellow
    Write-Host "  Checked: C:\msys64\mingw64\bin, C:\msys64\clang64\bin, C:\msys64\ucrt64\bin" -ForegroundColor Gray
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
$null = gcc -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_gcc.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "GCC"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (GCC not found or not in PATH)" -ForegroundColor Red
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #18: Fixed RDRAND/RDSEED Benchmark Script
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
$msys2Paths = @(
    "C:\msys64\mingw64\bin\clang.exe",
    "C:\msys64\clang64\bin\clang.exe",
    "C:\msys64\ucrt64\bin\clang.exe"
)
$msys2Clang = $null
foreach ($path in $msys2Paths) {
    if (Test-Path $path) {
        $msys2Clang = $path
        break
    }
}

if ($msys2Clang) {
    $null = & $msys2Clang -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK (found at $msys2Clang)" -ForegroundColor Green
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        $results += [PSCustomObject]@{
            Compiler = "Clang (GNU)"
            Method = "Intrinsic"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
        
        if ($rdrand_asm_speedup -ne 1) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Inline ASM"
                RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Compilation: SKIPPED (MSYS2 Clang not found in standard locations)" -ForegroundColor Yellow
    Write-Host "  Checked: C:\msys64\mingw64\bin, C:\msys64\clang64\bin, C:\msys64\ucrt64\bin" -ForegroundColor Gray
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
$null = gcc -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_gcc.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "GCC"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (GCC not found or not in PATH)" -ForegroundColor Red
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #19: Code‚ÄÇ‚àô‚ÄÇVersion 11
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
$msys2Paths = @(
    "C:\msys64\mingw64\bin\clang.exe",
    "C:\msys64\clang64\bin\clang.exe",
    "C:\msys64\ucrt64\bin\clang.exe"
)
$msys2Clang = $null
foreach ($path in $msys2Paths) {
    if (Test-Path $path) {
        $msys2Clang = $path
        break
    }
}

if ($msys2Clang) {
    $null = & $msys2Clang -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK (found at $msys2Clang)" -ForegroundColor Green
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        $results += [PSCustomObject]@{
            Compiler = "Clang (GNU)"
            Method = "Intrinsic"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
        
        if ($rdrand_asm_speedup -ne 1) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Inline ASM"
                RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Compilation: SKIPPED (MSYS2 Clang not found in standard locations)" -ForegroundColor Yellow
    Write-Host "  Checked: C:\msys64\mingw64\bin, C:\msys64\clang64\bin, C:\msys64\ucrt64\bin" -ForegroundColor Gray
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
$null = gcc -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_gcc.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "GCC"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (GCC not found or not in PATH)" -ForegroundColor Red
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #20: Fixed RDRAND/RDSEED Benchmark Script
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
$msys2Paths = @(
    "C:\msys64\mingw64\bin\clang.exe",
    "C:\msys64\clang64\bin\clang.exe",
    "C:\msys64\ucrt64\bin\clang.exe"
)
$msys2Clang = $null
foreach ($path in $msys2Paths) {
    if (Test-Path $path) {
        $msys2Clang = $path
        break
    }
}

if ($msys2Clang) {
    $null = & $msys2Clang -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK (found at $msys2Clang)" -ForegroundColor Green
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        $results += [PSCustomObject]@{
            Compiler = "Clang (GNU)"
            Method = "Intrinsic"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
        
        if ($rdrand_asm_speedup -ne 1) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Inline ASM"
                RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Compilation: SKIPPED (MSYS2 Clang not found in standard locations)" -ForegroundColor Yellow
    Write-Host "  Checked: C:\msys64\mingw64\bin, C:\msys64\clang64\bin, C:\msys64\ucrt64\bin" -ForegroundColor Gray
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
$null = gcc -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_gcc.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "GCC"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (GCC not found or not in PATH)" -ForegroundColor Red
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #21: Code‚ÄÇ‚àô‚ÄÇVersion 12
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 5000000;
    const int RDSEED_ITERATIONS = 500000;
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
$msys2Paths = @(
    "C:\msys64\mingw64\bin\clang.exe",
    "C:\msys64\clang64\bin\clang.exe",
    "C:\msys64\ucrt64\bin\clang.exe"
)
$msys2Clang = $null
foreach ($path in $msys2Paths) {
    if (Test-Path $path) {
        $msys2Clang = $path
        break
    }
}

if ($msys2Clang) {
    $null = & $msys2Clang -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK (found at $msys2Clang)" -ForegroundColor Green
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        $results += [PSCustomObject]@{
            Compiler = "Clang (GNU)"
            Method = "Intrinsic"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
        
        if ($rdrand_asm_speedup -ne 1) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Inline ASM"
                RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Compilation: SKIPPED (MSYS2 Clang not found in standard locations)" -ForegroundColor Yellow
    Write-Host "  Checked: C:\msys64\mingw64\bin, C:\msys64\clang64\bin, C:\msys64\ucrt64\bin" -ForegroundColor Gray
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
$null = gcc -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_gcc.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "GCC"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (GCC not found or not in PATH)" -ForegroundColor Red
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #22: Fixed RDRAND/RDSEED Benchmark Script
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
$msys2Paths = @(
    "C:\msys64\mingw64\bin\clang.exe",
    "C:\msys64\clang64\bin\clang.exe",
    "C:\msys64\ucrt64\bin\clang.exe"
)
$msys2Clang = $null
foreach ($path in $msys2Paths) {
    if (Test-Path $path) {
        $msys2Clang = $path
        break
    }
}

if ($msys2Clang) {
    $null = & $msys2Clang -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK (found at $msys2Clang)" -ForegroundColor Green
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        $results += [PSCustomObject]@{
            Compiler = "Clang (GNU)"
            Method = "Intrinsic"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
        
        if ($rdrand_asm_speedup -ne 1) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Inline ASM"
                RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Compilation: SKIPPED (MSYS2 Clang not found in standard locations)" -ForegroundColor Yellow
    Write-Host "  Checked: C:\msys64\mingw64\bin, C:\msys64\clang64\bin, C:\msys64\ucrt64\bin" -ForegroundColor Gray
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
$null = gcc -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_gcc.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "GCC"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (GCC not found or not in PATH)" -ForegroundColor Red
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #23: Code‚ÄÇ‚àô‚ÄÇVersion 13
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
$msys2Paths = @(
    "C:\msys64\mingw64\bin\clang.exe",
    "C:\msys64\clang64\bin\clang.exe",
    "C:\msys64\ucrt64\bin\clang.exe"
)
$msys2Clang = $null
foreach ($path in $msys2Paths) {
    if (Test-Path $path) {
        $msys2Clang = $path
        break
    }
}

if ($msys2Clang) {
    $null = & $msys2Clang -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK (found at $msys2Clang)" -ForegroundColor Green
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        $results += [PSCustomObject]@{
            Compiler = "Clang (GNU)"
            Method = "Intrinsic"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
        
        if ($rdrand_asm_speedup -ne 1) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Inline ASM"
                RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Compilation: SKIPPED (MSYS2 Clang not found in standard locations)" -ForegroundColor Yellow
    Write-Host "  Checked: C:\msys64\mingw64\bin, C:\msys64\clang64\bin, C:\msys64\ucrt64\bin" -ForegroundColor Gray
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
$null = gcc -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_gcc.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "GCC"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (GCC not found or not in PATH)" -ForegroundColor Red
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #24: Fixed RDRAND/RDSEED Benchmark Script
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
$msys2Paths = @(
    "C:\msys64\mingw64\bin\clang.exe",
    "C:\msys64\clang64\bin\clang.exe",
    "C:\msys64\ucrt64\bin\clang.exe"
)
$msys2Clang = $null
foreach ($path in $msys2Paths) {
    if (Test-Path $path) {
        $msys2Clang = $path
        break
    }
}

if ($msys2Clang) {
    $null = & $msys2Clang -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK (found at $msys2Clang)" -ForegroundColor Green
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        $results += [PSCustomObject]@{
            Compiler = "Clang (GNU)"
            Method = "Intrinsic"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
        
        if ($rdrand_asm_speedup -ne 1) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Inline ASM"
                RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Compilation: SKIPPED (MSYS2 Clang not found in standard locations)" -ForegroundColor Yellow
    Write-Host "  Checked: C:\msys64\mingw64\bin, C:\msys64\clang64\bin, C:\msys64\ucrt64\bin" -ForegroundColor Gray
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
$null = gcc -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_gcc.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "GCC"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (GCC not found or not in PATH)" -ForegroundColor Red
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #25: Code‚ÄÇ‚àô‚ÄÇVersion 14
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
$msys2Paths = @(
    "C:\msys64\mingw64\bin\clang.exe",
    "C:\msys64\clang64\bin\clang.exe",
    "C:\msys64\ucrt64\bin\clang.exe"
)
$msys2Clang = $null
foreach ($path in $msys2Paths) {
    if (Test-Path $path) {
        $msys2Clang = $path
        break
    }
}

if ($msys2Clang) {
    $null = & $msys2Clang -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK (found at $msys2Clang)" -ForegroundColor Green
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        $results += [PSCustomObject]@{
            Compiler = "Clang (GNU)"
            Method = "Intrinsic"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
        
        if ($rdrand_asm_speedup -ne 1) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Inline ASM"
                RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Compilation: SKIPPED (MSYS2 Clang not found in standard locations)" -ForegroundColor Yellow
    Write-Host "  Checked: C:\msys64\mingw64\bin, C:\msys64\clang64\bin, C:\msys64\ucrt64\bin" -ForegroundColor Gray
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
$null = gcc -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_gcc.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "GCC"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (GCC not found or not in PATH)" -ForegroundColor Red
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #27: Fixed RDRAND/RDSEED Benchmark Script
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# =====================================================
# Auto-detect compiler paths
# =====================================================
$clangWinPath = "D:\Programs\clang\bin\clang.exe"
$gccPath = "D:\Programs\msys64\ucrt64\bin\gcc.exe"
$clangGnuPath = "D:\Programs\msys64\ucrt64\bin\clang.exe"

Write-Host "`nDetecting compilers..." -ForegroundColor Yellow
Write-Host "  MSVC (cl): " -NoNewline
if (Get-Command cl -ErrorAction SilentlyContinue) {
    Write-Host "Found in PATH" -ForegroundColor Green
} else {
    Write-Host "Not in PATH" -ForegroundColor Red
}

Write-Host "  Clang (Win): " -NoNewline
if (Test-Path $clangWinPath) {
    Write-Host "Found at $clangWinPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangWinPath = $null
}

Write-Host "  GCC (MSYS2): " -NoNewline
if (Test-Path $gccPath) {
    Write-Host "Found at $gccPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $gccPath = $null
}

Write-Host "  Clang (GNU): " -NoNewline
if (Test-Path $clangGnuPath) {
    Write-Host "Found at $clangGnuPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangGnuPath = $null
}

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
$msys2Paths = @(
    "C:\msys64\mingw64\bin\clang.exe",
    "C:\msys64\clang64\bin\clang.exe",
    "C:\msys64\ucrt64\bin\clang.exe"
)
$msys2Clang = $null
foreach ($path in $msys2Paths) {
    if (Test-Path $path) {
        $msys2Clang = $path
        break
    }
}

if ($msys2Clang) {
    $null = & $msys2Clang -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK (found at $msys2Clang)" -ForegroundColor Green
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        $results += [PSCustomObject]@{
            Compiler = "Clang (GNU)"
            Method = "Intrinsic"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
        
        if ($rdrand_asm_speedup -ne 1) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Inline ASM"
                RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Compilation: SKIPPED (MSYS2 Clang not found in standard locations)" -ForegroundColor Yellow
    Write-Host "  Checked: C:\msys64\mingw64\bin, C:\msys64\clang64\bin, C:\msys64\ucrt64\bin" -ForegroundColor Gray
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
$null = gcc -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_gcc.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "GCC"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (GCC not found or not in PATH)" -ForegroundColor Red
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #28: Code‚ÄÇ‚àô‚ÄÇVersion 15
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# =====================================================
# Auto-detect compiler paths
# =====================================================
$clangWinPath = "D:\Programs\clang\bin\clang.exe"
$gccPath = "D:\Programs\msys64\ucrt64\bin\gcc.exe"
$clangGnuPath = "D:\Programs\msys64\ucrt64\bin\clang.exe"

Write-Host "`nDetecting compilers..." -ForegroundColor Yellow
Write-Host "  MSVC (cl): " -NoNewline
if (Get-Command cl -ErrorAction SilentlyContinue) {
    Write-Host "Found in PATH" -ForegroundColor Green
} else {
    Write-Host "Not in PATH" -ForegroundColor Red
}

Write-Host "  Clang (Win): " -NoNewline
if (Test-Path $clangWinPath) {
    Write-Host "Found at $clangWinPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangWinPath = $null
}

Write-Host "  GCC (MSYS2): " -NoNewline
if (Test-Path $gccPath) {
    Write-Host "Found at $gccPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $gccPath = $null
}

Write-Host "  Clang (GNU): " -NoNewline
if (Test-Path $clangGnuPath) {
    Write-Host "Found at $clangGnuPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangGnuPath = $null
}

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
$msys2Paths = @(
    "C:\msys64\mingw64\bin\clang.exe",
    "C:\msys64\clang64\bin\clang.exe",
    "C:\msys64\ucrt64\bin\clang.exe"
)
$msys2Clang = $null
foreach ($path in $msys2Paths) {
    if (Test-Path $path) {
        $msys2Clang = $path
        break
    }
}

if ($msys2Clang) {
    $null = & $msys2Clang -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK (found at $msys2Clang)" -ForegroundColor Green
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        $results += [PSCustomObject]@{
            Compiler = "Clang (GNU)"
            Method = "Intrinsic"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
        
        if ($rdrand_asm_speedup -ne 1) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Inline ASM"
                RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Compilation: SKIPPED (MSYS2 Clang not found in standard locations)" -ForegroundColor Yellow
    Write-Host "  Checked: C:\msys64\mingw64\bin, C:\msys64\clang64\bin, C:\msys64\ucrt64\bin" -ForegroundColor Gray
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
$null = gcc -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_gcc.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "GCC"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "GCC"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (GCC not found or not in PATH)" -ForegroundColor Red
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #29: Fixed RDRAND/RDSEED Benchmark Script
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# =====================================================
# Auto-detect compiler paths
# =====================================================
$clangWinPath = "D:\Programs\clang\bin\clang.exe"
$gccPath = "D:\Programs\msys64\ucrt64\bin\gcc.exe"
$clangGnuPath = "D:\Programs\msys64\ucrt64\bin\clang.exe"

Write-Host "`nDetecting compilers..." -ForegroundColor Yellow
Write-Host "  MSVC (cl): " -NoNewline
if (Get-Command cl -ErrorAction SilentlyContinue) {
    Write-Host "Found in PATH" -ForegroundColor Green
} else {
    Write-Host "Not in PATH" -ForegroundColor Red
}

Write-Host "  Clang (Win): " -NoNewline
if (Test-Path $clangWinPath) {
    Write-Host "Found at $clangWinPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangWinPath = $null
}

Write-Host "  GCC (MSYS2): " -NoNewline
if (Test-Path $gccPath) {
    Write-Host "Found at $gccPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $gccPath = $null
}

Write-Host "  Clang (GNU): " -NoNewline
if (Test-Path $clangGnuPath) {
    Write-Host "Found at $clangGnuPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangGnuPath = $null
}

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
if ($clangGnuPath) {
    $null = & $clangGnuPath -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $job = Start-Job -ScriptBlock { & ".\benchmark_clang_gnu.exe" 2>&1 }
        $completed = Wait-Job $job -Timeout 60
        
        if ($completed) {
            $output = Receive-Job $job | Out-String
            Remove-Job $job
            Write-Host $output
            
            $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            
            if ($rdrand -gt 0) {
                $results += [PSCustomObject]@{
                    Compiler = "Clang (GNU)"
                    Method = "Intrinsic"
                    RDRAND_ns = $rdrand
                    RDSEED_ns = $rdseed
                }
                
                if ($rdrand_asm_speedup -ne 1) {
                    $results += [PSCustomObject]@{
                        Compiler = "Clang (GNU)"
                        Method = "Inline ASM"
                        RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                        RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                    }
                }
            }
        } else {
            Remove-Job $job -Force
            Write-Host "  Execution: TIMEOUT" -ForegroundColor Red
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  SKIPPED (Clang not found at D:\Programs\msys64\ucrt64\bin)" -ForegroundColor Yellow
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
if ($gccPath) {
    $null = & $gccPath -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $job = Start-Job -ScriptBlock { & ".\benchmark_gcc.exe" 2>&1 }
        $completed = Wait-Job $job -Timeout 60
        
        if ($completed) {
            $output = Receive-Job $job | Out-String
            Remove-Job $job
            Write-Host $output
            
            $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            
            if ($rdrand -gt 0) {
                $results += [PSCustomObject]@{
                    Compiler = "GCC"
                    Method = "Intrinsic"
                    RDRAND_ns = $rdrand
                    RDSEED_ns = $rdseed
                }
                
                if ($rdrand_asm_speedup -ne 1) {
                    $results += [PSCustomObject]@{
                        Compiler = "GCC"
                        Method = "Inline ASM"
                        RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                        RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                    }
                }
            }
        } else {
            Remove-Job $job -Force
            Write-Host "  Execution: TIMEOUT" -ForegroundColor Red
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  SKIPPED (GCC not found at D:\Programs\msys64\ucrt64\bin)" -ForegroundColor Yellow
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #30: Code‚ÄÇ‚àô‚ÄÇVersion 18
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# =====================================================
# Auto-detect compiler paths
# =====================================================
$clangWinPath = "D:\Programs\clang\bin\clang.exe"
$gccPath = "D:\Programs\msys64\ucrt64\bin\gcc.exe"
$clangGnuPath = "D:\Programs\msys64\ucrt64\bin\clang.exe"

Write-Host "`nDetecting compilers..." -ForegroundColor Yellow
Write-Host "  MSVC (cl): " -NoNewline
if (Get-Command cl -ErrorAction SilentlyContinue) {
    Write-Host "Found in PATH" -ForegroundColor Green
} else {
    Write-Host "Not in PATH" -ForegroundColor Red
}

Write-Host "  Clang (Win): " -NoNewline
if (Test-Path $clangWinPath) {
    Write-Host "Found at $clangWinPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangWinPath = $null
}

Write-Host "  GCC (MSYS2): " -NoNewline
if (Test-Path $gccPath) {
    Write-Host "Found at $gccPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $gccPath = $null
}

Write-Host "  Clang (GNU): " -NoNewline
if (Test-Path $clangGnuPath) {
    Write-Host "Found at $clangGnuPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangGnuPath = $null
}

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
if ($clangGnuPath) {
    $null = & $clangGnuPath -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $job = Start-Job -ScriptBlock { & ".\benchmark_clang_gnu.exe" 2>&1 }
        $completed = Wait-Job $job -Timeout 60
        
        if ($completed) {
            $output = Receive-Job $job | Out-String
            Remove-Job $job
            Write-Host $output
            
            $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            
            if ($rdrand -gt 0) {
                $results += [PSCustomObject]@{
                    Compiler = "Clang (GNU)"
                    Method = "Intrinsic"
                    RDRAND_ns = $rdrand
                    RDSEED_ns = $rdseed
                }
                
                if ($rdrand_asm_speedup -ne 1) {
                    $results += [PSCustomObject]@{
                        Compiler = "Clang (GNU)"
                        Method = "Inline ASM"
                        RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                        RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                    }
                }
            }
        } else {
            Remove-Job $job -Force
            Write-Host "  Execution: TIMEOUT" -ForegroundColor Red
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  SKIPPED (Clang not found at D:\Programs\msys64\ucrt64\bin)" -ForegroundColor Yellow
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
if ($gccPath) {
    $null = & $gccPath -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $job = Start-Job -ScriptBlock { & ".\benchmark_gcc.exe" 2>&1 }
        $completed = Wait-Job $job -Timeout 60
        
        if ($completed) {
            $output = Receive-Job $job | Out-String
            Remove-Job $job
            Write-Host $output
            
            $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            
            if ($rdrand -gt 0) {
                $results += [PSCustomObject]@{
                    Compiler = "GCC"
                    Method = "Intrinsic"
                    RDRAND_ns = $rdrand
                    RDSEED_ns = $rdseed
                }
                
                if ($rdrand_asm_speedup -ne 1) {
                    $results += [PSCustomObject]@{
                        Compiler = "GCC"
                        Method = "Inline ASM"
                        RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                        RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                    }
                }
            }
        } else {
            Remove-Job $job -Force
            Write-Host "  Execution: TIMEOUT" -ForegroundColor Red
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  SKIPPED (GCC not found at D:\Programs\msys64\ucrt64\bin)" -ForegroundColor Yellow
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #31: Fixed RDRAND/RDSEED Benchmark Script
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# =====================================================
# Auto-detect compiler paths
# =====================================================
$clangWinPath = "D:\Programs\clang\bin\clang.exe"
$gccPath = "D:\Programs\msys64\ucrt64\bin\gcc.exe"
$clangGnuPath = "D:\Programs\msys64\ucrt64\bin\clang.exe"

Write-Host "`nDetecting compilers..." -ForegroundColor Yellow
Write-Host "  MSVC (cl): " -NoNewline
if (Get-Command cl -ErrorAction SilentlyContinue) {
    Write-Host "Found in PATH" -ForegroundColor Green
} else {
    Write-Host "Not in PATH" -ForegroundColor Red
}

Write-Host "  Clang (Win): " -NoNewline
if (Test-Path $clangWinPath) {
    Write-Host "Found at $clangWinPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangWinPath = $null
}

Write-Host "  GCC (MSYS2): " -NoNewline
if (Test-Path $gccPath) {
    Write-Host "Found at $gccPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $gccPath = $null
}

Write-Host "  Clang (GNU): " -NoNewline
if (Test-Path $clangGnuPath) {
    Write-Host "Found at $clangGnuPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangGnuPath = $null
}

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
if ($clangGnuPath) {
    $null = & $clangGnuPath -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $job = Start-Job -ScriptBlock { & ".\benchmark_clang_gnu.exe" 2>&1 }
        $completed = Wait-Job $job -Timeout 60
        
        if ($completed) {
            $output = Receive-Job $job | Out-String
            Remove-Job $job
            Write-Host $output
            
            $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            
            if ($rdrand -gt 0) {
                $results += [PSCustomObject]@{
                    Compiler = "Clang (GNU)"
                    Method = "Intrinsic"
                    RDRAND_ns = $rdrand
                    RDSEED_ns = $rdseed
                }
                
                if ($rdrand_asm_speedup -ne 1) {
                    $results += [PSCustomObject]@{
                        Compiler = "Clang (GNU)"
                        Method = "Inline ASM"
                        RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                        RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                    }
                }
            }
        } else {
            Remove-Job $job -Force
            Write-Host "  Execution: TIMEOUT" -ForegroundColor Red
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  SKIPPED (Clang not found at D:\Programs\msys64\ucrt64\bin)" -ForegroundColor Yellow
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
if ($gccPath) {
    $null = & $gccPath -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $job = Start-Job -ScriptBlock { & ".\benchmark_gcc.exe" 2>&1 }
        $completed = Wait-Job $job -Timeout 60
        
        if ($completed) {
            $output = Receive-Job $job | Out-String
            Remove-Job $job
            Write-Host $output
            
            $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            
            if ($rdrand -gt 0) {
                $results += [PSCustomObject]@{
                    Compiler = "GCC"
                    Method = "Intrinsic"
                    RDRAND_ns = $rdrand
                    RDSEED_ns = $rdseed
                }
                
                if ($rdrand_asm_speedup -ne 1) {
                    $results += [PSCustomObject]@{
                        Compiler = "GCC"
                        Method = "Inline ASM"
                        RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                        RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                    }
                }
            }
        } else {
            Remove-Job $job -Force
            Write-Host "  Execution: TIMEOUT" -ForegroundColor Red
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  SKIPPED (GCC not found at D:\Programs\msys64\ucrt64\bin)" -ForegroundColor Yellow
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #32: Code‚ÄÇ‚àô‚ÄÇVersion 19
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# =====================================================
# Auto-detect compiler paths
# =====================================================
$clangWinPath = "D:\Programs\clang\bin\clang.exe"
$gccPath = "D:\Programs\msys64\ucrt64\bin\gcc.exe"
$clangGnuPath = "D:\Programs\msys64\ucrt64\bin\clang.exe"

Write-Host "`nDetecting compilers..." -ForegroundColor Yellow
Write-Host "  MSVC (cl): " -NoNewline
if (Get-Command cl -ErrorAction SilentlyContinue) {
    Write-Host "Found in PATH" -ForegroundColor Green
} else {
    Write-Host "Not in PATH" -ForegroundColor Red
}

Write-Host "  Clang (Win): " -NoNewline
if (Test-Path $clangWinPath) {
    Write-Host "Found at $clangWinPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangWinPath = $null
}

Write-Host "  GCC (MSYS2): " -NoNewline
if (Test-Path $gccPath) {
    Write-Host "Found at $gccPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $gccPath = $null
}

Write-Host "  Clang (GNU): " -NoNewline
if (Test-Path $clangGnuPath) {
    Write-Host "Found at $clangGnuPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangGnuPath = $null
}

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
if ($clangGnuPath) {
    $null = & $clangGnuPath -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $job = Start-Job -ScriptBlock { & ".\benchmark_clang_gnu.exe" 2>&1 }
        $completed = Wait-Job $job -Timeout 60
        
        if ($completed) {
            $output = Receive-Job $job | Out-String
            Remove-Job $job
            Write-Host $output
            
            $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            
            if ($rdrand -gt 0) {
                $results += [PSCustomObject]@{
                    Compiler = "Clang (GNU)"
                    Method = "Intrinsic"
                    RDRAND_ns = $rdrand
                    RDSEED_ns = $rdseed
                }
                
                if ($rdrand_asm_speedup -ne 1) {
                    $results += [PSCustomObject]@{
                        Compiler = "Clang (GNU)"
                        Method = "Inline ASM"
                        RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                        RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                    }
                }
            }
        } else {
            Remove-Job $job -Force
            Write-Host "  Execution: TIMEOUT" -ForegroundColor Red
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  SKIPPED (Clang not found at D:\Programs\msys64\ucrt64\bin)" -ForegroundColor Yellow
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
if ($gccPath) {
    $null = & $gccPath -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $job = Start-Job -ScriptBlock { & ".\benchmark_gcc.exe" 2>&1 }
        $completed = Wait-Job $job -Timeout 60
        
        if ($completed) {
            $output = Receive-Job $job | Out-String
            Remove-Job $job
            Write-Host $output
            
            $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            
            if ($rdrand -gt 0) {
                $results += [PSCustomObject]@{
                    Compiler = "GCC"
                    Method = "Intrinsic"
                    RDRAND_ns = $rdrand
                    RDSEED_ns = $rdseed
                }
                
                if ($rdrand_asm_speedup -ne 1) {
                    $results += [PSCustomObject]@{
                        Compiler = "GCC"
                        Method = "Inline ASM"
                        RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                        RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                    }
                }
            }
        } else {
            Remove-Job $job -Force
            Write-Host "  Execution: TIMEOUT" -ForegroundColor Red
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  SKIPPED (GCC not found at D:\Programs\msys64\ucrt64\bin)" -ForegroundColor Yellow
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #33: Fixed RDRAND/RDSEED Benchmark Script
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# =====================================================
# Auto-detect compiler paths
# =====================================================
$clangWinPath = "D:\Programs\clang\bin\clang.exe"
$gccPath = "D:\Programs\msys64\ucrt64\bin\gcc.exe"
$clangGnuPath = "D:\Programs\msys64\ucrt64\bin\clang.exe"

Write-Host "`nDetecting compilers..." -ForegroundColor Yellow
Write-Host "  MSVC (cl): " -NoNewline
if (Get-Command cl -ErrorAction SilentlyContinue) {
    Write-Host "Found in PATH" -ForegroundColor Green
} else {
    Write-Host "Not in PATH" -ForegroundColor Red
}

Write-Host "  Clang (Win): " -NoNewline
if (Test-Path $clangWinPath) {
    Write-Host "Found at $clangWinPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangWinPath = $null
}

Write-Host "  GCC (MSYS2): " -NoNewline
if (Test-Path $gccPath) {
    Write-Host "Found at $gccPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $gccPath = $null
}

Write-Host "  Clang (GNU): " -NoNewline
if (Test-Path $clangGnuPath) {
    Write-Host "Found at $clangGnuPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangGnuPath = $null
}

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
if ($clangGnuPath) {
    # Set up MSYS2 library paths
    $env:PATH = "D:\Programs\msys64\ucrt64\bin;$env:PATH"
    
    $null = & $clangGnuPath -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
            
            $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            
            if ($rdrand -gt 0) {
                $results += [PSCustomObject]@{
                    Compiler = "Clang (GNU)"
                    Method = "Intrinsic"
                    RDRAND_ns = $rdrand
                    RDSEED_ns = $rdseed
                }
                
                if ($rdrand_asm_speedup -ne 1) {
                    $results += [PSCustomObject]@{
                        Compiler = "Clang (GNU)"
                        Method = "Inline ASM"
                        RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                        RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                    }
                }
            }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  SKIPPED (Clang not found at D:\Programs\msys64\ucrt64\bin)" -ForegroundColor Yellow
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
if ($gccPath) {
    # Set up MSYS2 library paths
    $env:PATH = "D:\Programs\msys64\ucrt64\bin;$env:PATH"
    
    $null = & $gccPath -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $output = & .\benchmark_gcc.exe 2>&1 | Out-String
        Write-Host $output
            
            $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            
            if ($rdrand -gt 0) {
                $results += [PSCustomObject]@{
                    Compiler = "GCC"
                    Method = "Intrinsic"
                    RDRAND_ns = $rdrand
                    RDSEED_ns = $rdseed
                }
                
                if ($rdrand_asm_speedup -ne 1) {
                    $results += [PSCustomObject]@{
                        Compiler = "GCC"
                        Method = "Inline ASM"
                        RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                        RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                    }
                }
            }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  SKIPPED (GCC not found at D:\Programs\msys64\ucrt64\bin)" -ForegroundColor Yellow
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #34: Code‚ÄÇ‚àô‚ÄÇVersion 24
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# =====================================================
# Auto-detect compiler paths
# =====================================================
$clangWinPath = "D:\Programs\clang\bin\clang.exe"
$gccPath = "D:\Programs\msys64\ucrt64\bin\gcc.exe"
$clangGnuPath = "D:\Programs\msys64\ucrt64\bin\clang.exe"

Write-Host "`nDetecting compilers..." -ForegroundColor Yellow
Write-Host "  MSVC (cl): " -NoNewline
if (Get-Command cl -ErrorAction SilentlyContinue) {
    Write-Host "Found in PATH" -ForegroundColor Green
} else {
    Write-Host "Not in PATH" -ForegroundColor Red
}

Write-Host "  Clang (Win): " -NoNewline
if (Test-Path $clangWinPath) {
    Write-Host "Found at $clangWinPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangWinPath = $null
}

Write-Host "  GCC (MSYS2): " -NoNewline
if (Test-Path $gccPath) {
    Write-Host "Found at $gccPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $gccPath = $null
}

Write-Host "  Clang (GNU): " -NoNewline
if (Test-Path $clangGnuPath) {
    Write-Host "Found at $clangGnuPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangGnuPath = $null
}

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
if ($clangGnuPath) {
    # Set up MSYS2 library paths
    $env:PATH = "D:\Programs\msys64\ucrt64\bin;$env:PATH"
    
    $null = & $clangGnuPath -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
            
            $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            
            if ($rdrand -gt 0) {
                $results += [PSCustomObject]@{
                    Compiler = "Clang (GNU)"
                    Method = "Intrinsic"
                    RDRAND_ns = $rdrand
                    RDSEED_ns = $rdseed
                }
                
                if ($rdrand_asm_speedup -ne 1) {
                    $results += [PSCustomObject]@{
                        Compiler = "Clang (GNU)"
                        Method = "Inline ASM"
                        RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                        RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                    }
                }
            }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  SKIPPED (Clang not found at D:\Programs\msys64\ucrt64\bin)" -ForegroundColor Yellow
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
if ($gccPath) {
    # Set up MSYS2 library paths
    $env:PATH = "D:\Programs\msys64\ucrt64\bin;$env:PATH"
    
    $null = & $gccPath -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $output = & .\benchmark_gcc.exe 2>&1 | Out-String
        Write-Host $output
            
            $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            
            if ($rdrand -gt 0) {
                $results += [PSCustomObject]@{
                    Compiler = "GCC"
                    Method = "Intrinsic"
                    RDRAND_ns = $rdrand
                    RDSEED_ns = $rdseed
                }
                
                if ($rdrand_asm_speedup -ne 1) {
                    $results += [PSCustomObject]@{
                        Compiler = "GCC"
                        Method = "Inline ASM"
                        RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                        RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                    }
                }
            }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  SKIPPED (GCC not found at D:\Programs\msys64\ucrt64\bin)" -ForegroundColor Yellow
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #35: Fixed RDRAND/RDSEED Benchmark Script
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# =====================================================
# Auto-detect compiler paths
# =====================================================
$clangWinPath = "D:\Programs\clang\bin\clang.exe"
$gccPath = "D:\Programs\msys64\ucrt64\bin\gcc.exe"
$clangGnuPath = "D:\Programs\msys64\ucrt64\bin\clang.exe"

Write-Host "`nDetecting compilers..." -ForegroundColor Yellow
Write-Host "  MSVC (cl): " -NoNewline
if (Get-Command cl -ErrorAction SilentlyContinue) {
    Write-Host "Found in PATH" -ForegroundColor Green
} else {
    Write-Host "Not in PATH" -ForegroundColor Red
}

Write-Host "  Clang (Win): " -NoNewline
if (Test-Path $clangWinPath) {
    Write-Host "Found at $clangWinPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangWinPath = $null
}

Write-Host "  GCC (MSYS2): " -NoNewline
if (Test-Path $gccPath) {
    Write-Host "Found at $gccPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $gccPath = $null
}

Write-Host "  Clang (GNU): " -NoNewline
if (Test-Path $clangGnuPath) {
    Write-Host "Found at $clangGnuPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangGnuPath = $null
}

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
if ($clangGnuPath) {
    # Set up MSYS2 library paths
    $env:PATH = "D:\Programs\msys64\ucrt64\bin;$env:PATH"
    
    $null = & $clangGnuPath -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
            
            $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            
            if ($rdrand -gt 0) {
                $results += [PSCustomObject]@{
                    Compiler = "Clang (GNU)"
                    Method = "Intrinsic"
                    RDRAND_ns = $rdrand
                    RDSEED_ns = $rdseed
                }
                
                if ($rdrand_asm_speedup -ne 1) {
                    $results += [PSCustomObject]@{
                        Compiler = "Clang (GNU)"
                        Method = "Inline ASM"
                        RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                        RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                    }
                }
            }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  SKIPPED (Clang not found at D:\Programs\msys64\ucrt64\bin)" -ForegroundColor Yellow
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
if ($gccPath) {
    # Set up MSYS2 library paths
    $env:PATH = "D:\Programs\msys64\ucrt64\bin;$env:PATH"
    
    $null = & $gccPath -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $output = & .\benchmark_gcc.exe 2>&1 | Out-String
        Write-Host $output
            
            $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            
            if ($rdrand -gt 0) {
                $results += [PSCustomObject]@{
                    Compiler = "GCC"
                    Method = "Intrinsic"
                    RDRAND_ns = $rdrand
                    RDSEED_ns = $rdseed
                }
                
                if ($rdrand_asm_speedup -ne 1) {
                    $results += [PSCustomObject]@{
                        Compiler = "GCC"
                        Method = "Inline ASM"
                        RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                        RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                    }
                }
            }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  SKIPPED (GCC not found at D:\Programs\msys64\ucrt64\bin)" -ForegroundColor Yellow
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #36: Code‚ÄÇ‚àô‚ÄÇVersion 25
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# =====================================================
# Auto-detect compiler paths
# =====================================================
$clangWinPath = "D:\Programs\clang\bin\clang.exe"
$gccPath = "D:\Programs\msys64\ucrt64\bin\gcc.exe"
$clangGnuPath = "D:\Programs\msys64\ucrt64\bin\clang.exe"

Write-Host "`nDetecting compilers..." -ForegroundColor Yellow
Write-Host "  MSVC (cl): " -NoNewline
if (Get-Command cl -ErrorAction SilentlyContinue) {
    Write-Host "Found in PATH" -ForegroundColor Green
} else {
    Write-Host "Not in PATH" -ForegroundColor Red
}

Write-Host "  Clang (Win): " -NoNewline
if (Test-Path $clangWinPath) {
    Write-Host "Found at $clangWinPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangWinPath = $null
}

Write-Host "  GCC (MSYS2): " -NoNewline
if (Test-Path $gccPath) {
    Write-Host "Found at $gccPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $gccPath = $null
}

Write-Host "  Clang (GNU): " -NoNewline
if (Test-Path $clangGnuPath) {
    Write-Host "Found at $clangGnuPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangGnuPath = $null
}

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
if ($clangGnuPath) {
    # Set up MSYS2 library paths
    $env:PATH = "D:\Programs\msys64\ucrt64\bin;$env:PATH"
    
    $null = & $clangGnuPath -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
            
            $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            
            if ($rdrand -gt 0) {
                $results += [PSCustomObject]@{
                    Compiler = "Clang (GNU)"
                    Method = "Intrinsic"
                    RDRAND_ns = $rdrand
                    RDSEED_ns = $rdseed
                }
                
                if ($rdrand_asm_speedup -ne 1) {
                    $results += [PSCustomObject]@{
                        Compiler = "Clang (GNU)"
                        Method = "Inline ASM"
                        RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                        RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                    }
                }
            }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  SKIPPED (Clang not found at D:\Programs\msys64\ucrt64\bin)" -ForegroundColor Yellow
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
if ($gccPath) {
    # Set up MSYS2 library paths
    $env:PATH = "D:\Programs\msys64\ucrt64\bin;$env:PATH"
    
    $null = & $gccPath -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $output = & .\benchmark_gcc.exe 2>&1 | Out-String
        Write-Host $output
            
            $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
            $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
            
            if ($rdrand -gt 0) {
                $results += [PSCustomObject]@{
                    Compiler = "GCC"
                    Method = "Intrinsic"
                    RDRAND_ns = $rdrand
                    RDSEED_ns = $rdseed
                }
                
                if ($rdrand_asm_speedup -ne 1) {
                    $results += [PSCustomObject]@{
                        Compiler = "GCC"
                        Method = "Inline ASM"
                        RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                        RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                    }
                }
            }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  SKIPPED (GCC not found at D:\Programs\msys64\ucrt64\bin)" -ForegroundColor Yellow
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #37: Fixed RDRAND/RDSEED Benchmark Script
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# =====================================================
# Auto-detect compiler paths
# =====================================================
$clangWinPath = "D:\Programs\clang\bin\clang.exe"
$gccPath = "D:\Programs\msys64\ucrt64\bin\gcc.exe"
$clangGnuPath = "D:\Programs\msys64\ucrt64\bin\clang.exe"

Write-Host "`nDetecting compilers..." -ForegroundColor Yellow
Write-Host "  MSVC (cl): " -NoNewline
if (Get-Command cl -ErrorAction SilentlyContinue) {
    Write-Host "Found in PATH" -ForegroundColor Green
} else {
    Write-Host "Not in PATH" -ForegroundColor Red
}

Write-Host "  Clang (Win): " -NoNewline
if (Test-Path $clangWinPath) {
    Write-Host "Found at $clangWinPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangWinPath = $null
}

Write-Host "  GCC (MSYS2): " -NoNewline
if (Test-Path $gccPath) {
    Write-Host "Found at $gccPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $gccPath = $null
}

Write-Host "  Clang (GNU): " -NoNewline
if (Test-Path $clangGnuPath) {
    Write-Host "Found at $clangGnuPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangGnuPath = $null
}

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
if ($clangGnuPath -and (Test-Path $clangGnuPath)) {
    # Set up MSYS2 library paths
    $env:PATH = "D:\Programs\msys64\ucrt64\bin;$env:PATH"
    
    Write-Host "  Compiling with $clangGnuPath..." -ForegroundColor Cyan
    $compileOutput = & $clangGnuPath -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    
    if ($LASTEXITCODE -eq 0 -and (Test-Path "benchmark_clang_gnu.exe")) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
            
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
            
            if ($rdrand_asm_speedup -ne 1) {
                $results += [PSCustomObject]@{
                    Compiler = "Clang (GNU)"
                    Method = "Inline ASM"
                    RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                    RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                }
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
        Write-Host "  Error output:" -ForegroundColor Yellow
        Write-Host $compileOutput -ForegroundColor Gray
    }
} else {
    Write-Host "  SKIPPED (Clang not found at $clangGnuPath)" -ForegroundColor Yellow
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
if ($gccPath -and (Test-Path $gccPath)) {
    # Set up MSYS2 library paths
    $env:PATH = "D:\Programs\msys64\ucrt64\bin;$env:PATH"
    
    Write-Host "  Compiling with $gccPath..." -ForegroundColor Cyan
    $compileOutput = & $gccPath -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
    
    if ($LASTEXITCODE -eq 0 -and (Test-Path "benchmark_gcc.exe")) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $output = & .\benchmark_gcc.exe 2>&1 | Out-String
        Write-Host $output
            
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "GCC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
            
            if ($rdrand_asm_speedup -ne 1) {
                $results += [PSCustomObject]@{
                    Compiler = "GCC"
                    Method = "Inline ASM"
                    RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                    RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                }
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
        Write-Host "  Error output:" -ForegroundColor Yellow
        Write-Host $compileOutput -ForegroundColor Gray
    }
} else {
    Write-Host "  SKIPPED (GCC not found at $gccPath)" -ForegroundColor Yellow
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #38: Code‚ÄÇ‚àô‚ÄÇVersion 27
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# =====================================================
# Auto-detect compiler paths
# =====================================================
$clangWinPath = "D:\Programs\clang\bin\clang.exe"
$gccPath = "D:\Programs\msys64\ucrt64\bin\gcc.exe"
$clangGnuPath = "D:\Programs\msys64\ucrt64\bin\clang.exe"

Write-Host "`nDetecting compilers..." -ForegroundColor Yellow
Write-Host "  MSVC (cl): " -NoNewline
if (Get-Command cl -ErrorAction SilentlyContinue) {
    Write-Host "Found in PATH" -ForegroundColor Green
} else {
    Write-Host "Not in PATH" -ForegroundColor Red
}

Write-Host "  Clang (Win): " -NoNewline
if (Test-Path $clangWinPath) {
    Write-Host "Found at $clangWinPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangWinPath = $null
}

Write-Host "  GCC (MSYS2): " -NoNewline
if (Test-Path $gccPath) {
    Write-Host "Found at $gccPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $gccPath = $null
}

Write-Host "  Clang (GNU): " -NoNewline
if (Test-Path $clangGnuPath) {
    Write-Host "Found at $clangGnuPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangGnuPath = $null
}

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
    __cpuid(cpuInfo, 1);
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
    __cpuidex(cpuInfo, 7, 0);
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
if ($clangGnuPath -and (Test-Path $clangGnuPath)) {
    # Set up MSYS2 library paths
    $env:PATH = "D:\Programs\msys64\ucrt64\bin;$env:PATH"
    
    Write-Host "  Compiling with $clangGnuPath..." -ForegroundColor Cyan
    $compileOutput = & $clangGnuPath -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    
    if ($LASTEXITCODE -eq 0 -and (Test-Path "benchmark_clang_gnu.exe")) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
            
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
            
            if ($rdrand_asm_speedup -ne 1) {
                $results += [PSCustomObject]@{
                    Compiler = "Clang (GNU)"
                    Method = "Inline ASM"
                    RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                    RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                }
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
        Write-Host "  Error output:" -ForegroundColor Yellow
        Write-Host $compileOutput -ForegroundColor Gray
    }
} else {
    Write-Host "  SKIPPED (Clang not found at $clangGnuPath)" -ForegroundColor Yellow
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
if ($gccPath -and (Test-Path $gccPath)) {
    # Set up MSYS2 library paths
    $env:PATH = "D:\Programs\msys64\ucrt64\bin;$env:PATH"
    
    Write-Host "  Compiling with $gccPath..." -ForegroundColor Cyan
    $compileOutput = & $gccPath -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
    
    if ($LASTEXITCODE -eq 0 -and (Test-Path "benchmark_gcc.exe")) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $output = & .\benchmark_gcc.exe 2>&1 | Out-String
        Write-Host $output
            
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "GCC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
            
            if ($rdrand_asm_speedup -ne 1) {
                $results += [PSCustomObject]@{
                    Compiler = "GCC"
                    Method = "Inline ASM"
                    RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                    RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                }
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
        Write-Host "  Error output:" -ForegroundColor Yellow
        Write-Host $compileOutput -ForegroundColor Gray
    }
} else {
    Write-Host "  SKIPPED (GCC not found at $gccPath)" -ForegroundColor Yellow
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #39: Fixed RDRAND/RDSEED Benchmark Script
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# =====================================================
# Auto-detect compiler paths
# =====================================================
$clangWinPath = "D:\Programs\clang\bin\clang.exe"
$gccPath = "D:\Programs\msys64\ucrt64\bin\gcc.exe"
$clangGnuPath = "D:\Programs\msys64\ucrt64\bin\clang.exe"

Write-Host "`nDetecting compilers..." -ForegroundColor Yellow
Write-Host "  MSVC (cl): " -NoNewline
if (Get-Command cl -ErrorAction SilentlyContinue) {
    Write-Host "Found in PATH" -ForegroundColor Green
} else {
    Write-Host "Not in PATH" -ForegroundColor Red
}

Write-Host "  Clang (Win): " -NoNewline
if (Test-Path $clangWinPath) {
    Write-Host "Found at $clangWinPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangWinPath = $null
}

Write-Host "  GCC (MSYS2): " -NoNewline
if (Test-Path $gccPath) {
    Write-Host "Found at $gccPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $gccPath = $null
}

Write-Host "  Clang (GNU): " -NoNewline
if (Test-Path $clangGnuPath) {
    Write-Host "Found at $clangGnuPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangGnuPath = $null
}

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
#ifdef _MSC_VER
    __cpuid(cpuInfo, 1);
#else
    __asm__ __volatile__ (
        "cpuid"
        : "=a" (cpuInfo[0]), "=b" (cpuInfo[1]), "=c" (cpuInfo[2]), "=d" (cpuInfo[3])
        : "a" (1), "c" (0)
    );
#endif
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
#ifdef _MSC_VER
    __cpuidex(cpuInfo, 7, 0);
#else
    __asm__ __volatile__ (
        "cpuid"
        : "=a" (cpuInfo[0]), "=b" (cpuInfo[1]), "=c" (cpuInfo[2]), "=d" (cpuInfo[3])
        : "a" (7), "c" (0)
    );
#endif
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
if ($clangGnuPath -and (Test-Path $clangGnuPath)) {
    # Set up MSYS2 library paths
    $env:PATH = "D:\Programs\msys64\ucrt64\bin;$env:PATH"
    
    Write-Host "  Compiling with $clangGnuPath..." -ForegroundColor Cyan
    $compileOutput = & $clangGnuPath -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    
    if ($LASTEXITCODE -eq 0 -and (Test-Path "benchmark_clang_gnu.exe")) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
            
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
            
            if ($rdrand_asm_speedup -ne 1) {
                $results += [PSCustomObject]@{
                    Compiler = "Clang (GNU)"
                    Method = "Inline ASM"
                    RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                    RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                }
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
        Write-Host "  Error output:" -ForegroundColor Yellow
        Write-Host $compileOutput -ForegroundColor Gray
    }
} else {
    Write-Host "  SKIPPED (Clang not found at $clangGnuPath)" -ForegroundColor Yellow
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
if ($gccPath -and (Test-Path $gccPath)) {
    # Set up MSYS2 library paths
    $env:PATH = "D:\Programs\msys64\ucrt64\bin;$env:PATH"
    
    Write-Host "  Compiling with $gccPath..." -ForegroundColor Cyan
    $compileOutput = & $gccPath -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
    
    if ($LASTEXITCODE -eq 0 -and (Test-Path "benchmark_gcc.exe")) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $output = & .\benchmark_gcc.exe 2>&1 | Out-String
        Write-Host $output
            
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "GCC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
            
            if ($rdrand_asm_speedup -ne 1) {
                $results += [PSCustomObject]@{
                    Compiler = "GCC"
                    Method = "Inline ASM"
                    RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                    RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                }
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
        Write-Host "  Error output:" -ForegroundColor Yellow
        Write-Host $compileOutput -ForegroundColor Gray
    }
} else {
    Write-Host "  SKIPPED (GCC not found at $gccPath)" -ForegroundColor Yellow
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #40: Code‚ÄÇ‚àô‚ÄÇVersion 28
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# =====================================================
# Auto-detect compiler paths
# =====================================================
$clangWinPath = "D:\Programs\clang\bin\clang.exe"
$gccPath = "D:\Programs\msys64\ucrt64\bin\gcc.exe"
$clangGnuPath = "D:\Programs\msys64\ucrt64\bin\clang.exe"

Write-Host "`nDetecting compilers..." -ForegroundColor Yellow
Write-Host "  MSVC (cl): " -NoNewline
if (Get-Command cl -ErrorAction SilentlyContinue) {
    Write-Host "Found in PATH" -ForegroundColor Green
} else {
    Write-Host "Not in PATH" -ForegroundColor Red
}

Write-Host "  Clang (Win): " -NoNewline
if (Test-Path $clangWinPath) {
    Write-Host "Found at $clangWinPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangWinPath = $null
}

Write-Host "  GCC (MSYS2): " -NoNewline
if (Test-Path $gccPath) {
    Write-Host "Found at $gccPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $gccPath = $null
}

Write-Host "  Clang (GNU): " -NoNewline
if (Test-Path $clangGnuPath) {
    Write-Host "Found at $clangGnuPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangGnuPath = $null
}

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
#ifdef _MSC_VER
    __cpuid(cpuInfo, 1);
#else
    __asm__ __volatile__ (
        "cpuid"
        : "=a" (cpuInfo[0]), "=b" (cpuInfo[1]), "=c" (cpuInfo[2]), "=d" (cpuInfo[3])
        : "a" (1), "c" (0)
    );
#endif
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
#ifdef _MSC_VER
    __cpuidex(cpuInfo, 7, 0);
#else
    __asm__ __volatile__ (
        "cpuid"
        : "=a" (cpuInfo[0]), "=b" (cpuInfo[1]), "=c" (cpuInfo[2]), "=d" (cpuInfo[3])
        : "a" (7), "c" (0)
    );
#endif
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
if ($clangGnuPath -and (Test-Path $clangGnuPath)) {
    # Set up MSYS2 library paths
    $env:PATH = "D:\Programs\msys64\ucrt64\bin;$env:PATH"
    
    Write-Host "  Compiling with $clangGnuPath..." -ForegroundColor Cyan
    $compileOutput = & $clangGnuPath -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    
    if ($LASTEXITCODE -eq 0 -and (Test-Path "benchmark_clang_gnu.exe")) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
            
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
            
            if ($rdrand_asm_speedup -ne 1) {
                $results += [PSCustomObject]@{
                    Compiler = "Clang (GNU)"
                    Method = "Inline ASM"
                    RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                    RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                }
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
        Write-Host "  Error output:" -ForegroundColor Yellow
        Write-Host $compileOutput -ForegroundColor Gray
    }
} else {
    Write-Host "  SKIPPED (Clang not found at $clangGnuPath)" -ForegroundColor Yellow
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
if ($gccPath -and (Test-Path $gccPath)) {
    # Set up MSYS2 library paths
    $env:PATH = "D:\Programs\msys64\ucrt64\bin;$env:PATH"
    
    Write-Host "  Compiling with $gccPath..." -ForegroundColor Cyan
    $compileOutput = & $gccPath -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
    
    if ($LASTEXITCODE -eq 0 -and (Test-Path "benchmark_gcc.exe")) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $output = & .\benchmark_gcc.exe 2>&1 | Out-String
        Write-Host $output
            
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "GCC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
            
            if ($rdrand_asm_speedup -ne 1) {
                $results += [PSCustomObject]@{
                    Compiler = "GCC"
                    Method = "Inline ASM"
                    RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                    RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                }
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
        Write-Host "  Error output:" -ForegroundColor Yellow
        Write-Host $compileOutput -ForegroundColor Gray
    }
} else {
    Write-Host "  SKIPPED (GCC not found at $gccPath)" -ForegroundColor Yellow
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #41: Fixed RDRAND/RDSEED Benchmark Script
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# =====================================================
# Auto-detect compiler paths
# =====================================================
$clangWinPath = "D:\Programs\clang\bin\clang.exe"
$gccPath = "D:\Programs\msys64\ucrt64\bin\gcc.exe"
$clangGnuPath = "D:\Programs\msys64\ucrt64\bin\clang.exe"

Write-Host "`nDetecting compilers..." -ForegroundColor Yellow
Write-Host "  MSVC (cl): " -NoNewline
if (Get-Command cl -ErrorAction SilentlyContinue) {
    Write-Host "Found in PATH" -ForegroundColor Green
} else {
    Write-Host "Not in PATH" -ForegroundColor Red
}

Write-Host "  Clang (Win): " -NoNewline
if (Test-Path $clangWinPath) {
    Write-Host "Found at $clangWinPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangWinPath = $null
}

Write-Host "  GCC (MSYS2): " -NoNewline
if (Test-Path $gccPath) {
    Write-Host "Found at $gccPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $gccPath = $null
}

Write-Host "  Clang (GNU): " -NoNewline
if (Test-Path $clangGnuPath) {
    Write-Host "Found at $clangGnuPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangGnuPath = $null
}

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
#ifdef _MSC_VER
    __cpuid(cpuInfo, 1);
#else
    __asm__ __volatile__ (
        "cpuid"
        : "=a" (cpuInfo[0]), "=b" (cpuInfo[1]), "=c" (cpuInfo[2]), "=d" (cpuInfo[3])
        : "a" (1), "c" (0)
    );
#endif
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
#ifdef _MSC_VER
    __cpuidex(cpuInfo, 7, 0);
#else
    __asm__ __volatile__ (
        "cpuid"
        : "=a" (cpuInfo[0]), "=b" (cpuInfo[1]), "=c" (cpuInfo[2]), "=d" (cpuInfo[3])
        : "a" (7), "c" (0)
    );
#endif
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
if ($clangGnuPath -and (Test-Path $clangGnuPath)) {
    # Set up MSYS2 library paths
    $env:PATH = "D:\Programs\msys64\ucrt64\bin;$env:PATH"
    
    Write-Host "  Compiling with $clangGnuPath..." -ForegroundColor Cyan
    $compileOutput = & $clangGnuPath -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    
    if ($LASTEXITCODE -eq 0 -and (Test-Path "benchmark_clang_gnu.exe")) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
            
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
            
            if ($rdrand_asm_speedup -ne 1) {
                $results += [PSCustomObject]@{
                    Compiler = "Clang (GNU)"
                    Method = "Inline ASM"
                    RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                    RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                }
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
        Write-Host "  Error output:" -ForegroundColor Yellow
        Write-Host $compileOutput -ForegroundColor Gray
    }
} else {
    Write-Host "  SKIPPED (Clang not found at $clangGnuPath)" -ForegroundColor Yellow
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
if ($gccPath -and (Test-Path $gccPath)) {
    # Set up MSYS2 library paths
    $env:PATH = "D:\Programs\msys64\ucrt64\bin;$env:PATH"
    
    Write-Host "  Compiling with $gccPath..." -ForegroundColor Cyan
    $compileOutput = & $gccPath -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
    
    if ($LASTEXITCODE -eq 0 -and (Test-Path "benchmark_gcc.exe")) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $output = & .\benchmark_gcc.exe 2>&1 | Out-String
        Write-Host $output
            
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "GCC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
            
            if ($rdrand_asm_speedup -ne 1) {
                $results += [PSCustomObject]@{
                    Compiler = "GCC"
                    Method = "Inline ASM"
                    RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                    RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                }
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
        Write-Host "  Error output:" -ForegroundColor Yellow
        Write-Host $compileOutput -ForegroundColor Gray
    }
} else {
    Write-Host "  SKIPPED (GCC not found at $gccPath)" -ForegroundColor Yellow
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan



================================================================================
ARTIFACT #42: Code‚ÄÇ‚àô‚ÄÇVersion 29
================================================================================

# =====================================================
# Comprehensive RDRAND/RDSEED Benchmark - All Compilers
# =====================================================

Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  RDRAND/RDSEED Multi-Compiler Benchmark" -ForegroundColor Cyan
Write-Host "  Testing: MSVC, Clang (Win), Clang (GNU), GCC, MASM" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

# =====================================================
# Auto-detect compiler paths
# =====================================================
$clangWinPath = "D:\Programs\clang\bin\clang.exe"
$gccPath = "D:\Programs\msys64\ucrt64\bin\gcc.exe"
$clangGnuPath = "D:\Programs\msys64\ucrt64\bin\clang.exe"

Write-Host "`nDetecting compilers..." -ForegroundColor Yellow
Write-Host "  MSVC (cl): " -NoNewline
if (Get-Command cl -ErrorAction SilentlyContinue) {
    Write-Host "Found in PATH" -ForegroundColor Green
} else {
    Write-Host "Not in PATH" -ForegroundColor Red
}

Write-Host "  Clang (Win): " -NoNewline
if (Test-Path $clangWinPath) {
    Write-Host "Found at $clangWinPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangWinPath = $null
}

Write-Host "  GCC (MSYS2): " -NoNewline
if (Test-Path $gccPath) {
    Write-Host "Found at $gccPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $gccPath = $null
}

Write-Host "  Clang (GNU): " -NoNewline
if (Test-Path $clangGnuPath) {
    Write-Host "Found at $clangGnuPath" -ForegroundColor Green
} else {
    Write-Host "Not found" -ForegroundColor Red
    $clangGnuPath = $null
}

# Create C source code with all implementations
$cCode = @'
#include <stdio.h>
#include <stdint.h>
#include <immintrin.h>
#include <windows.h>

#ifdef _MSC_VER
#include <intrin.h>
#endif

// CPU feature detection
int check_rdrand_support() {
    int cpuInfo[4];
#ifdef _MSC_VER
    __cpuid(cpuInfo, 1);
#else
    __asm__ __volatile__ (
        "cpuid"
        : "=a" (cpuInfo[0]), "=b" (cpuInfo[1]), "=c" (cpuInfo[2]), "=d" (cpuInfo[3])
        : "a" (1), "c" (0)
    );
#endif
    return (cpuInfo[2] & (1 << 30)) != 0;
}

int check_rdseed_support() {
    int cpuInfo[4];
#ifdef _MSC_VER
    __cpuidex(cpuInfo, 7, 0);
#else
    __asm__ __volatile__ (
        "cpuid"
        : "=a" (cpuInfo[0]), "=b" (cpuInfo[1]), "=c" (cpuInfo[2]), "=d" (cpuInfo[3])
        : "a" (7), "c" (0)
    );
#endif
    return (cpuInfo[1] & (1 << 18)) != 0;
}

// Inline assembly versions (Clang/GCC only)
#if defined(__clang__) || defined(__GNUC__)
__attribute__((noinline))
uint64_t rdrand64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdrand %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}

__attribute__((noinline))
uint64_t rdseed64_inline_asm(void) {
    uint64_t result;
    int success;
    do {
        __asm__ volatile ("rdseed %0; setc %1" : "=r" (result), "=qm" (success));
    } while (!success);
    return result;
}
#endif

// Intrinsic version (all compilers)
#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdrand64_intrinsic(void) {
    uint64_t result;
    while (!_rdrand64_step(&result)) {
        _mm_pause();
    }
    return result;
}

#ifdef _MSC_VER
__declspec(noinline)
#else
__attribute__((noinline))
#endif
uint64_t rdseed64_intrinsic(void) {
    uint64_t result;
    while (!_rdseed64_step(&result)) {
        _mm_pause();
    }
    return result;
}

// Benchmark function
double benchmark(const char* name, uint64_t (*func)(void), int iterations, int show_progress) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    if (show_progress) {
        printf("  %s: ", name);
        fflush(stdout);
    }
    
    // Warmup
    for (int i = 0; i < 1000; i++) {
        func();
    }
    
    QueryPerformanceCounter(&start);
    
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    if (show_progress) {
        printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    }
    
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: ");
#ifdef _MSC_VER
    printf("MSVC %d", _MSC_VER);
#elif defined(__clang__)
    printf("Clang %s", __clang_version__);
#elif defined(__GNUC__)
    printf("GCC %d.%d.%d", __GNUC__, __GNUC_MINOR__, __GNUC_PATCHLEVEL__);
#endif
    printf("\n");
    
    int has_rdrand = check_rdrand_support();
    int has_rdseed = check_rdseed_support();
    
    if (!has_rdrand) {
        printf("ERROR: RDRAND not supported\n");
        return 1;
    }
    
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand_intrinsic = benchmark("Intrinsic", rdrand64_intrinsic, RDRAND_ITERATIONS, 1);
    
#if defined(__clang__) || defined(__GNUC__)
    double rdrand_asm = benchmark("Inline ASM", rdrand64_inline_asm, RDRAND_ITERATIONS, 1);
    printf("RDRAND_ASM_SPEEDUP:%.4f\n", rdrand_intrinsic / rdrand_asm);
#endif
    
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand_intrinsic);
    
    if (has_rdseed) {
        printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
        double rdseed_intrinsic = benchmark("Intrinsic", rdseed64_intrinsic, RDSEED_ITERATIONS, 1);
        
#if defined(__clang__) || defined(__GNUC__)
        double rdseed_asm = benchmark("Inline ASM", rdseed64_inline_asm, RDSEED_ITERATIONS, 1);
        printf("RDSEED_ASM_SPEEDUP:%.4f\n", rdseed_intrinsic / rdseed_asm);
#endif
        
        printf("RDSEED_INTRINSIC:%.2f\n", rdseed_intrinsic);
        printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed_intrinsic / rdrand_intrinsic);
    }
    
    return 0;
}
'@

$cCode | Out-File -Encoding ASCII -FilePath benchmark_multi.c

# Create MASM assembly source
$asmCode = @'
.code

; RDRAND 64-bit function
public rdrand64_asm
rdrand64_asm proc
retry_rdrand:
    rdrand rax
    jnc retry_rdrand
    ret
rdrand64_asm endp

; RDSEED 64-bit function
public rdseed64_asm
rdseed64_asm proc
retry_rdseed:
    rdseed rax
    jnc retry_rdseed
    ret
rdseed64_asm endp

end
'@

$asmCode | Out-File -Encoding ASCII -FilePath rdrand_asm.asm

# Create C wrapper for MASM
$masmWrapper = @'
#include <stdio.h>
#include <stdint.h>
#include <windows.h>

extern uint64_t rdrand64_asm(void);
extern uint64_t rdseed64_asm(void);

double benchmark(const char* name, uint64_t (*func)(void), int iterations) {
    LARGE_INTEGER frequency, start, end;
    QueryPerformanceFrequency(&frequency);
    
    printf("  %s: ", name);
    fflush(stdout);
    
    for (int i = 0; i < 1000; i++) func();
    
    QueryPerformanceCounter(&start);
    uint64_t sum = 0;
    for (int i = 0; i < iterations; i++) {
        sum += func();
    }
    QueryPerformanceCounter(&end);
    
    double elapsed = (double)(end.QuadPart - start.QuadPart) / frequency.QuadPart;
    double ns_per_call = (elapsed * 1e9) / iterations;
    
    printf("%.2f ns/call (%.2f M/sec)\n", ns_per_call, iterations / elapsed / 1e6);
    return ns_per_call;
}

int main() {
    const int RDRAND_ITERATIONS = 100000;  // Reduced from 5M to 100K
    const int RDSEED_ITERATIONS = 50000;   // Reduced from 500K to 50K
    
    printf("Compiler: MASM + MSVC\n");
    printf("\nRDRAND Benchmarks (%d iterations):\n", RDRAND_ITERATIONS);
    double rdrand = benchmark("Pure ASM", rdrand64_asm, RDRAND_ITERATIONS);
    printf("RDRAND_INTRINSIC:%.2f\n", rdrand);
    
    printf("\nRDSEED Benchmarks (%d iterations):\n", RDSEED_ITERATIONS);
    double rdseed = benchmark("Pure ASM", rdseed64_asm, RDSEED_ITERATIONS);
    printf("RDSEED_INTRINSIC:%.2f\n", rdseed);
    printf("RDSEED_VS_RDRAND:%.2fx\n", rdseed / rdrand);
    
    return 0;
}
'@

$masmWrapper | Out-File -Encoding ASCII -FilePath benchmark_masm.c

# Results storage
$results = @()

# Test MSVC
Write-Host "`n[1/6] Testing MSVC..." -ForegroundColor Yellow
$null = cl /O2 /nologo benchmark_multi.c /link /OUT:benchmark_msvc.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    Write-Host "  Running benchmark (this may take 10-30 seconds)..." -ForegroundColor Cyan
    
    # Run with timeout
    $job = Start-Job -ScriptBlock { & ".\benchmark_msvc.exe" 2>&1 }
    $completed = Wait-Job $job -Timeout 60
    
    if ($completed) {
        $output = Receive-Job $job | Out-String
        Remove-Job $job
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "MSVC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
        }
    } else {
        Remove-Job $job -Force
        Write-Host "  Execution: TIMEOUT (hung for >60 seconds)" -ForegroundColor Red
        Write-Host "  This likely means RDRAND is very slow or not working properly on your CPU" -ForegroundColor Yellow
    }
} else {
    Write-Host "  Compilation: FAILED" -ForegroundColor Red
}

# Test Clang (Windows - MSVC ABI)
Write-Host "`n[2/6] Testing Clang (Windows/MSVC ABI)..." -ForegroundColor Yellow
$null = clang -O3 -march=native benchmark_multi.c -o benchmark_clang_win.exe 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "  Compilation: OK" -ForegroundColor Green
    $output = & .\benchmark_clang_win.exe 2>&1 | Out-String
    Write-Host $output
    
    $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
    $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
    
    $results += [PSCustomObject]@{
        Compiler = "Clang (Win)"
        Method = "Intrinsic"
        RDRAND_ns = $rdrand
        RDSEED_ns = $rdseed
    }
    
    if ($rdrand_asm_speedup -ne 1) {
        $results += [PSCustomObject]@{
            Compiler = "Clang (Win)"
            Method = "Inline ASM"
            RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
            RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
        }
    }
} else {
    Write-Host "  Compilation: FAILED (Clang not found or not in PATH)" -ForegroundColor Red
}

# Test Clang (MSYS2/GNU toolchain)
Write-Host "`n[3/6] Testing Clang (MSYS2/GNU toolchain)..." -ForegroundColor Yellow
if ($clangGnuPath -and (Test-Path $clangGnuPath)) {
    # Set up MSYS2 library paths
    $env:PATH = "D:\Programs\msys64\ucrt64\bin;$env:PATH"
    
    Write-Host "  Compiling with $clangGnuPath..." -ForegroundColor Cyan
    $compileOutput = & $clangGnuPath -O3 -march=native benchmark_multi.c -o benchmark_clang_gnu.exe 2>&1
    
    if ($LASTEXITCODE -eq 0 -and (Test-Path "benchmark_clang_gnu.exe")) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $output = & .\benchmark_clang_gnu.exe 2>&1 | Out-String
        Write-Host $output
            
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "Clang (GNU)"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
            
            if ($rdrand_asm_speedup -ne 1) {
                $results += [PSCustomObject]@{
                    Compiler = "Clang (GNU)"
                    Method = "Inline ASM"
                    RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                    RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                }
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
        Write-Host "  Error output:" -ForegroundColor Yellow
        Write-Host $compileOutput -ForegroundColor Gray
    }
} else {
    Write-Host "  SKIPPED (Clang not found at $clangGnuPath)" -ForegroundColor Yellow
}

# Test GCC (MinGW/MSYS2)
Write-Host "`n[4/6] Testing GCC (GNU toolchain)..." -ForegroundColor Yellow
if ($gccPath -and (Test-Path $gccPath)) {
    # Set up MSYS2 library paths
    $env:PATH = "D:\Programs\msys64\ucrt64\bin;$env:PATH"
    
    Write-Host "  Compiling with $gccPath..." -ForegroundColor Cyan
    $compileOutput = & $gccPath -O3 -march=native benchmark_multi.c -o benchmark_gcc.exe 2>&1
    
    if ($LASTEXITCODE -eq 0 -and (Test-Path "benchmark_gcc.exe")) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        Write-Host "  Running benchmark..." -ForegroundColor Cyan
        
        $output = & .\benchmark_gcc.exe 2>&1 | Out-String
        Write-Host $output
            
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdrand_asm_speedup = if ($output -match "RDRAND_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        $rdseed_asm_speedup = if ($output -match "RDSEED_ASM_SPEEDUP:([\d.]+)") { [double]$matches[1] } else { 1 }
        
        if ($rdrand -gt 0) {
            $results += [PSCustomObject]@{
                Compiler = "GCC"
                Method = "Intrinsic"
                RDRAND_ns = $rdrand
                RDSEED_ns = $rdseed
            }
            
            if ($rdrand_asm_speedup -ne 1) {
                $results += [PSCustomObject]@{
                    Compiler = "GCC"
                    Method = "Inline ASM"
                    RDRAND_ns = ($rdrand / $rdrand_asm_speedup)
                    RDSEED_ns = ($rdseed / $rdseed_asm_speedup)
                }
            }
        }
    } else {
        Write-Host "  Compilation: FAILED" -ForegroundColor Red
        Write-Host "  Error output:" -ForegroundColor Yellow
        Write-Host $compileOutput -ForegroundColor Gray
    }
} else {
    Write-Host "  SKIPPED (GCC not found at $gccPath)" -ForegroundColor Yellow
}

# Test MASM
Write-Host "`n[5/6] Testing MASM (Pure Assembly)..." -ForegroundColor Yellow
$null = ml64 /c /nologo rdrand_asm.asm 2>&1
if ($LASTEXITCODE -eq 0) {
    $null = cl /O2 /nologo benchmark_masm.c rdrand_asm.obj /link /OUT:benchmark_masm.exe 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "  Compilation: OK" -ForegroundColor Green
        $output = & .\benchmark_masm.exe 2>&1 | Out-String
        Write-Host $output
        
        $rdrand = if ($output -match "RDRAND_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        $rdseed = if ($output -match "RDSEED_INTRINSIC:([\d.]+)") { [double]$matches[1] } else { 0 }
        
        $results += [PSCustomObject]@{
            Compiler = "MASM"
            Method = "Pure ASM"
            RDRAND_ns = $rdrand
            RDSEED_ns = $rdseed
        }
    } else {
        Write-Host "  Linking: FAILED" -ForegroundColor Red
    }
} else {
    Write-Host "  Assembly: FAILED (MASM not found)" -ForegroundColor Red
}

# Display Results Table
Write-Host "`n=====================================================" -ForegroundColor Cyan
Write-Host "  BENCHMARK RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "=====================================================" -ForegroundColor Cyan

if ($results.Count -gt 0) {
    Write-Host "`nRDRAND Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Format-Table -Property Compiler, Method, @{Label="RDRAND (ns)";Expression={"{0:N2}" -f $_.RDRAND_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDRAND_ns)};Align="Right"} -AutoSize
    
    Write-Host "`nRDSEED Performance (lower is better):" -ForegroundColor Yellow
    $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Format-Table -Property Compiler, Method, @{Label="RDSEED (ns)";Expression={"{0:N2}" -f $_.RDSEED_ns};Align="Right"}, @{Label="Speed (M/s)";Expression={"{0:N2}" -f (1000/$_.RDSEED_ns)};Align="Right"} -AutoSize
    
    # Find fastest
    $fastest_rdrand = $results | Where-Object { $_.RDRAND_ns -gt 0 } | Sort-Object RDRAND_ns | Select-Object -First 1
    $fastest_rdseed = $results | Where-Object { $_.RDSEED_ns -gt 0 } | Sort-Object RDSEED_ns | Select-Object -First 1
    
    Write-Host "=====================================================" -ForegroundColor Cyan
    Write-Host "Fastest RDRAND: $($fastest_rdrand.Compiler) ($($fastest_rdrand.Method)) - $("{0:N2}" -f $fastest_rdrand.RDRAND_ns) ns/call" -ForegroundColor Green
    if ($fastest_rdseed) {
        Write-Host "Fastest RDSEED: $($fastest_rdseed.Compiler) ($($fastest_rdseed.Method)) - $("{0:N2}" -f $fastest_rdseed.RDSEED_ns) ns/call" -ForegroundColor Green
    }
    Write-Host "=====================================================" -ForegroundColor Cyan
} else {
    Write-Host "`nNo successful compilations!" -ForegroundColor Red
}

Write-Host "`nDone! Executables and source files saved in current directory." -ForegroundColor Cyan


